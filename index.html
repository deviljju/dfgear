<!DOCTYPE html>
<html>
    <head>
		<title>Where is Mist Gear</title>
    <!--JQuery-->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <!--Bootstrap-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4" crossorigin="anonymous" ></script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5735118798197779"
     crossorigin="anonymous"></script>
		<script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>		
		<style>
      html {
        width: 100%;
        height: 100%;
      }
      body {
        width: 100%;
        user-select: none;
        overflow-x: hidden;
        height: 100%;
        min-height: 180px;
        overflow-y: auto;
      }
      body::-webkit-scrollbar {
        display: none;
      }
      .container {
        display: flex;
        align-items: center;
        width: 100%;
        height: 90%;
        max-width: 100vw;
        flex-direction: column;
        align-content: center;
      }
      .container > div {
        width: calc(500px - 1.5rem);
        height: 50px;
      }
			.row > #serverId {
        width: 8rem !important;
        margin-right: 0.3rem;
      }
      .row > #characterName {
        width: 16rem !important;
        margin-right: 0.3rem;
      }
      .row > #btn_search {
        width: 4rem !important;
      }
      #apiDiv {
        display: flex;
        align-items: center;
      }
      #apiKey {
        display: none;
        width:22rem;
        margin:0.5rem 0.5rem 0.5rem 0 !important
      }
      #btn_epicList {
        margin:0.5rem 0 !important;
        display: none;
      }
      #btn_epicList.show {
        display: block;
      }
      #mistList {
        overflow-y: auto;
        max-height: calc(100vh - 5rem - 200px);
      }
      #loading {
        display: none;
      }
      .offcanvas.show {
        width: 50vw !important;
      }
      .neopleThk {
        text-align: center;
        width: 100%;
        height: 10%;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .neopleThk > a:first-child {
        margin-right: 1rem;
      }
      .neopleThk > a {
        color:#000000
      }
      .neopleThk > a:hover {
        color:#fabe00
      }
		</style>
  </head>
  <body>
    <div class="container">
      <div class="row" style="margin-top:3rem">
        <select id="serverId" class="form-select" name="server">
          <option value="anton">안톤</option>
          <option value="bakal">바칼</option>
          <option value="cain">카인</option>
          <option value="casillas">카시야스</option>
          <option value="diregie">디레지에</option>
          <option value="hilder">힐더</option>
          <option value="prey" selected>프레이</option>
          <option value="siroco">시로코</option>
        </select>
        <input id="characterName" type="text" class="form-control" name="name" placeholder="캐릭터명을 입력하세요" autocomplete="off">
        <button id="btn_search" class="btn btn-primary">조회</button>
      </div>
      <div id="apiDiv">
        <input id="apiKey" type="text" class="form-control" name="apikey" placeholder="APIKEY" autocomplete="off">
        <button id="btn_epicList" class="btn btn-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight">상세보기</button>
      </div>      
      <div class="row d-flex justify-content-center" style="margin-top: 0.5rem;">
        <div id="loading" class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>        
        <div class="results"></div>
      </div>
    </div>
    <div class="neopleThk">
      <a href="https://cors-anywhere.herokuapp.com/corsdemo" target="_blank">CORS helped by herokuapp</a>
      <a href="http://developers.neople.co.kr" target="_blank">Powered by Neople OpenAPI</a>
    </div>
    <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasRight" aria-labelledby="offcanvasRightLabel">
      <div class="offcanvas-header">
        <h5 id="offcanvasRightLabel">에픽 획득 리스트</h5>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body">
        없음
      </div>
    </div>

    <script>
      let apioff=false;
      let timeLineList = [];
      let nowDate = moment().format("YYYYMMDDTHHmm");
			let API="";
      $(document).ready(function() {
        try{
          if(location.search.length>1){
            API = new URLSearchParams(location.search).get('key');
            if(API.length>3){
              $("#apiKey").val(API);    
            }
          }          
        } catch(e){
          API="";
        }
        $("#characterName").keyup(function () {
            if (window.event.keyCode == 13) {
              Search();
            }
        });
        $(document).on("click", "#btn_search", function() {
          Search();
        });
        $(document).on("click", "#btn_epicList", function() {
          let html = "";
          if(timeLineList.length>1){
            timeLineList.forEach(element => {
              html += `<div>${element.date} | ${element.mistGear ? "*" : ""} ${element.itemName} | ${element.channel}</div>`
            });
          }
          $('.offcanvas-body').html(html);
        })
      });
      function Search(){
          if(apioff){
            return alert("DNF점검");
          }
          var serverId = $("select[name='server']").val();
          var characterName = $("input[name='name']").val();
          if(characterName.length<1){
            alert("캐릭터명을 입력해주세요");
            return $("#characterName").focus();
          }
          if($("#apiKey").val().length>1){
            API =  $("#apiKey").val();    
          } else if(API==="INPUT" && $("#apiKey").val().length<1){
            alert("apiKey를 입력해주세요");
            return $("#apiKey").focus();
          }
          nowDate = moment().subtract(1,"m").format("YYYYMMDDTHHmm");
          loadingToggle();
          $(".results").html("");
          searchcharacterId(serverId,characterName,function(characterInfo, err_ch){
            try{
              timeLineList = [];
              if(err_ch){
                loadingToggle(false);
                $("#btn_epicList").removeClass("show");
                if(characterInfo.responseText && characterInfo.responseText.indexOf("cors") > -1){
                  API="INPUT";
                  $("#apiKey").css('display','block');
                  return alert("CORS에러_화면하단 CORS링크로 들어가 demo server 버튼을 눌러주세요");
                } else if(characterInfo.responseText && characterInfo.responseText.indexOf("APIKEY") > -1){
                  API="INPUT";
                  $("#apiKey").css('display','block');
                  return alert("에러 발생_APIKEY오류");
                } else {
                  API="INPUT";
                  $("#apiKey").css('display','block');
                  console.log(err_ch);
                  console.log(characterInfo);
                  return alert("에러 발생");
                }              
              } else {
                if(characterInfo.error){
                  loadingToggle(false);
                  $("#btn_epicList").removeClass("show");
                  if(characterInfo.error.message=="APIKEY_AUTH_ERROR"){
                    API="INPUT";
                    $("#apiKey").css('display','block');
                    return alert("에러 발생_APIKEY오류");
                  } else if(characterInfo.error.message=="SYSTEM_INSPECT"){
                    apioff=true;
                    return alert("DNF점검");
                  } else {
                    console.log(characterInfo);
                    return alert("에러 발생_캐릭터정보오류");
                  }
                } else if(characterInfo.rows.length>0){
                  var characterId = characterInfo.rows[0].characterId;
                  searchTimeLineEpic(serverId, characterId,"", function(timeLineInfo, err_tl){
                    try{
                      if(err_tl){
                        loadingToggle(false);
                        $("#btn_epicList").removeClass("show");
                        console.log(timeLineInfo);
                        return alert("에러 발생_타임라인오류, 다시 시도해주세요");
                      } else {
                        data_List(timeLineList);
                      }
                    }catch(timeErr){
                      console.log(timeErr);
                      loadingToggle(false);
                      return alert("에러 발생");
                    }
                  })
                } else {
                  loadingToggle(false);
                  $("#btn_epicList").removeClass("show");
                  return alert("일치하는 캐릭터 정보가 없습니다");
                }
              }
            } catch(chinfoErr){
              console.log(chinfoErr);
              loadingToggle(false);
              return alert("에러 발생");
            }
          })
      }
      function loadingToggle(toe=true) {
        if(toe){
          $("#loading").css("display","block");
          $("#btn_search").addClass("disabled");
        } else {
          $("#loading").css("display","");
          $("#btn_search").removeClass("disabled");
        }
      }
			function data_List(Array) {
				let newArray=[];
				let mistGear=[];
				let mistGearCount=1;
				let html=``;
				Array = Array.sort((a, b) => {
          return new Date(a.date) - new Date(b.date)
        })
				Array.forEach(element => {
					if(element.data.dungeonName ==="균형의 중재자"){
						newArray.push({ code:element.code, date:element.date, itemName:element.data.itemName, mistGear:element.data.mistGear, count: mistGearCount, channel:`${element.data.channelName}_${element.data.channelNo}` });
						if(!element.data.mistGear){
							mistGearCount++;
						} else {
							mistGear.push({code:element.code, missCount : mistGearCount, count:newArray.length, itemName:element.data.itemName });
							mistGearCount = 1;
						}
					} else if(element.data.mistGear) {
						newArray.push({ code:element.code, date:element.date, itemName: `${element.data.itemName} (${element.data.dungeonName})`, mistGear:element.data.mistGear, count: mistGearCount, channel:`` });
						mistGear.push({ code:element.code, missCount : mistGearCount, count:newArray.length, itemName: `${element.data.itemName}_${element.data.dungeonName}` });
						mistGearCount = 1;
					}
				});
				timeLineList = newArray;
				console.log(newArray);
				html +=`<div> 중재자 획득 에픽 수 : ${newArray.length}</div><div style="font-weight: bold;">미스트기어 리스트</div><div id="mistList">`;
        if(mistGear.length>0){
          mistGear.forEach(e => {
            html +=`<div> 미기 ${e.code==505 ? "드랍" : "카드"} : ${e.count}번째 에픽, ${e.itemName} </div>`;
          })
        } else {
          html +=`<div>where is Mist Gear`;
        }
        html += `</div>`;
				$(".results").html(html);
        loadingToggle(false);
        $("#btn_epicList").addClass("show");
      }
      function searchcharacterId(serverId,characterName, callback){
        try{
          let url = "https://api.neople.co.kr/df/servers/";
          if(API===""){
            url = `https://lq9sk4l959.execute-api.ap-northeast-2.amazonaws.com/beta/mistgearAPI?cmd=character&serverId=${serverId}&characterName=${encodeURIComponent(characterName)}`;
          } else {
            url = `https://cors-anywhere.herokuapp.com/https://api.neople.co.kr/df/servers/${serverId}/characters?characterName=${encodeURIComponent(characterName)}&apikey=${API}`;
          }
          $.ajax({
              url: url,
              type: 'get',
              timeout: 60000,
              success: function(result, textStatus, jqXHR){
                  callback(result,null);
              },
              error: function(jqXHR, error) {
                  callback(jqXHR,error);
              }
          });
        } catch(e){
          console.log(e);
        }
      }
      function searchTimeLineEpic(serverId, characterId, next="", callback){
        try{
          if(!serverId || !characterId){
            return callback(null,"nameError");
          }
          let url = "https://api.neople.co.kr/df/servers/";
          if(API===""){
            url = `https://lq9sk4l959.execute-api.ap-northeast-2.amazonaws.com/beta/mistgearAPI?cmd=timeline&serverId=${serverId}&characterId=${characterId}&endDate=${nowDate}&next=${next}`;
          } else {
            url = `https://cors-anywhere.herokuapp.com/https://api.neople.co.kr/df/servers/${serverId}/characters/${characterId}/timeline?limit=100&code=505&startDate=20230914&endDate=${nowDate}&next=${next}&apikey=${API}`;
          }
          $.ajax({
              url: url,
              type: 'get',
              success: function(result, textStatus, jqXHR){
                timeLineList.unshift(...result.timeline.rows);
                if(result.timeline.next == null){
                  callback("complete",null);
                } else {                  
                  searchTimeLineEpic(serverId, characterId, result.timeline.next,(res,err)=>{
										callback("complete",null);
									})
                }
              },
              error: function(jqXHR, error) {
                callback(jqXHR,error);
              }
          });
        } catch(e){
          console.log(e);
        }
      }
    </script>
  </body>
</html>
