let apioff=!1,nowDate=moment().format("YYYYMMDDTHHmm");const channelMap={};let streamerList;function loadingToggle(e=!0){e?($("#loadingScreen").css("height",$(document).height()),$("#loadingScreen").addClass("active"),$("#btn_search").addClass("disabled")):($("#loadingScreen").removeClass("active"),$("#btn_search").removeClass("disabled"))}function getList(){try{if(apioff||"0"===sessionStorage.getItem("serverState"))return toast("warning","DFGEAR 서버 점검");let e=localStorage.getItem("streamer");if(null!=e){let t=JSON.parse(e);t.update<=moment().subtract(10,"m").format("YYYYMMDDTHHmm")?searchList(function(e,t){try{if(t){if(loadingToggle(!1),!e.responseText)return console.log(t),console.log(e),alert("에러 발생");checkError(e.responseText)}else{if(!(e.data&&e.data.length>0))return loadingToggle(!1),$("#table").text("스트리머 리스트를 불러오는데 실패했습니다."),toast("danger","스트리머 리스트를 불러오는데 실패했습니다.");createTable(e.data),localStorage.setItem("streamer",JSON.stringify(e))}}catch(e){return loadingToggle(!1),alert("에러 발생")}}):createTable(t.data)}else searchList(function(e,t){try{if(t){if(loadingToggle(!1),!e.responseText)return console.log(t),console.log(e),alert("에러 발생");checkError(e.responseText)}else{if(!(e.data&&e.data.length>0))return loadingToggle(!1),$("#table").text("스트리머 리스트를 불러오는데 실패했습니다."),toast("danger","스트리머 리스트를 불러오는데 실패했습니다.");createTable(e.data),localStorage.setItem("streamer",JSON.stringify(e))}}catch(e){return loadingToggle(!1),alert("에러 발생")}})}catch(e){return loadingToggle(!1),alert("에러 발생")}}function searchList(e){try{callGearAPI("/strm",{},e)}catch(e){console.log(e)}}function createTable(e){streamerList=new tui.Grid({el:document.getElementById("table"),data:e,bodyHeight:"fitToParent",columns:[{header:"순위",name:"rank",sortable:!0,width:64,align:"center"},{header:"스트리머명",name:"stmName",sortable:!0,align:"center",minWidth:190,renderer:{type:channelName}},{header:"모험단명",name:"adventureName",align:"center",renderer:{type:colHover}},{header:"심연:숭배자",name:"abyss",sortable:!0,align:"center"},{header:"태초",name:"begin",sortable:!0,align:"center"},{header:"에픽",name:"epic",sortable:!0,align:"center"},{header:"레전더리",name:"legnd",sortable:!0,align:"center"},{header:"비율",name:"rate",sortable:!0,width:70,align:"center"}],header:{height:45},rowHeight:50,columnOptions:{resizable:!0},summary:{height:20,position:"bottom",columnContent:{begin:{template:function(e){return numberFmt(e.sum)}},epic:{template:function(e){return numberFmt(e.sum)}},defaultContent:"static content"}},scrollY:!0,useClientSort:!0,onGridMounted(e){streamerList.on("click",e=>{"etc"!==e.targetType&&"columnHeader"!==e.targetType&&("stmName"!==e.columnName&&"adventureName"!=e.columnName||(location.href=`./strmDetail?id=${streamerList.getValue(e.rowKey,"id")}`))}),streamerList.getData().forEach((e,t)=>{channelMap[e.stmName]=e.imgUrl});let t=streamerList.getSummaryValues("begin").sum,a=streamerList.getSummaryValues("epic").sum;streamerList.setSummaryColumnContent("rate",(t/a).toFixed(3)),$("#streamerName").keyup(function(){13==window.event.keyCode&&Search(streamerList)}),$(document).on("click","#btn_search",function(){Search(streamerList)})}})}function Search(e){try{let t=$("#streamerName").val(),a=streamerList.getData().find(e=>e.stmName.indexOf(t)>-1).rowKey;null!=a&&e.focus(a)}catch(e){console.log(e)}}tui.Grid.applyTheme("default",{cell:{normal:{background:"#fff"},header:{background:"#fff",border:"#e0e0e0"},selectedHeader:{background:"#fff"},disabled:{background:"#dc3545",text:"#fff"},focused:{border:"none"}}}),$(document).ready(function(){nowDate=moment().format("YYYYMMDDTHHmm"),$(document).on("click","#btn_lightmode",function(e){ligthModeChange(e.target)}),$(document).on("click",".row.title",function(){try{location.href="./"}catch(e){sessionStorage.clear(),location.href="https://dfgear.xyz"}}),$(window).resize(function(){$("#loadingScreen").css("height",$(document).height())}),getList()});