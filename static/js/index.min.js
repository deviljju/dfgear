let apioff=!1,timeLineList=[];const serverList=["all","anton","bakal","cain","casillas","diregie","hilder","prey","siroco"];let aggreInterval,epicMapChart,beginMapChart,nowDate=moment().format("YYYYMMDDTHHmm"),serverId="",characterName="",characterId="";function Search(){if(apioff||"0"===sessionStorage.getItem("serverState"))return toast("warning","DFGEAR 서버 점검");var e=$("select[name='server']").val(),a=$("input[name='name']").val();return(a=a.trim()).length<1?(toast("danger","캐릭터명을 입력해주세요."),$("#characterName").focus()):(nowDate=moment().subtract(1,"m").format("YYYYMMDDTHHmm"),$(".resultData").removeClass("show"),$("#characterList").html(""),$("#advenResult").removeClass("show"),$("#btn_mistList").removeClass("show"),"adventure"===e?a.length>29?(toast("danger","모험단명은 30자리 이내로 입력해주세요"),$("#searchBar").addClass("show"),$("#characterName").focus()):(recentApply(e,a,""),sessionStorage.setItem("cName",a),location.href=`./adventure?cName=${encodeURIComponent(a)}`):a.length>20?(toast("danger","캐릭터명은 20자리 이내로 입력해주세요"),$("#searchBar").addClass("show"),$("#characterName").focus()):serverList.includes(e)?(loadingToggle(),void searchAll(e,a,function(t,r){$("#errSearch").removeClass("show"),sessionStorage.clear(),$("#searchError").removeClass("show"),$("#searchErrorDetail").removeClass("show");try{if(r){if(loadingToggle(!1),!t.responseText)return console.log(r),console.log(t),alert("에러 발생");$("#searchError").text(`"${a}" 검색 결과`).addClass("show"),checkError(t.responseText),$("#searchError").removeClass("show"),$("#searchErrorDetail").removeClass("show")}else{if(!t.rows||!(t.rows.length>1||"all"==e))return t.rows&&1==t.rows.length&&"all"!=e?(loadingToggle(!1),recentApply(e,a,t.rows[0].characterId),sessionStorage.clear(),sessionStorage.setItem("sId",e),sessionStorage.setItem("cName",a),sessionStorage.setItem("cId",t.rows[0].characterId),location.href="https://dfgear.xyz/character"):(loadingToggle(!1),$("#advenResult").removeClass("show"),$("#btn_mistList").removeClass("show"),$("#searchError").text(`"${a}" 검색 결과`).addClass("show"),$("#searchErrorDetail").addClass("show"),$(".recentBox").removeClass("active"),toast("danger","일치하는 캐릭터 정보가 없습니다"));makeCardView(t.rows,!1),0==t.rows.length&&$("#errSearch").addClass("show"),$("#advenTotal").html(`${a} 조회 결과`),recentApply(e,a,""),$(".recentBox").removeClass("active")}}catch(e){return sessionStorage.clear(),loadingToggle(!1),"NO_CHARACTER"===e?toast("danger","일치하는 캐릭터 정보가 없습니다"):alert("에러 발생")}})):(toast("danger","서버를 다시 선택해주세요"),$("#searchBar").addClass("show"),$("select[name='server']").focus()))}function loadingToggle(e=!0){e?($("#loadingScreen").css("height",$(document).height()),$("#loadingScreen").addClass("active"),$("#btn_search").addClass("disabled")):($("#loadingScreen").removeClass("active"),$("#btn_search").removeClass("disabled"))}function makeCardView(e,a=!0){try{let a=0,t=0,r=0;$("#characterList").html(""),e.forEach(e=>{try{let s=`<div class="card characterView" data-cId="${e.characterId}" data-sId="${e.serverId}" onclick="location.href='/character?sId=${e.serverId}&cId=${e.characterId}&cName=${encodeURIComponent(e.characterName)}';">\n        <div class="raidCnt flex flex-row items-center gap-1"><img src="./static/images/raid.png"><div>${e.raidCnt||"0"}</div></div>  \n        <img src="https://img-api.neople.co.kr/df/servers/${e.serverId}/characters/${e.characterId}/" class="card-img-top" alt="...">\n          <div class="card-body"><div class="flex flex-row gap-1 items-center ho-c"><img class="g-chimg" src="./static/images/fame.png"><div class="fameNumber">${e.fame}</div></div>  `;s+=`<span class="card-text cName uselct">${e.characterName}</span>            \n          <p class="card-text jobserver">${convertServer(e.serverId)}<span></span>${e.jobGrowName}</p>`,s+=`<span class="card-text uselct be">태초 획득 : ${e.begin}</span>\n            <span class="card-text uselct to">에픽 획득 : ${e.epic}</span>\n            <span class="card-text uselct mi">레전더리 획득 : ${e.legnd}</span>\n            <span class="card-text uselct mb-1">심연:숭배자 : ${e.abyss?e.abyss:"-"}</span>`,s+=`<span class="card-text uselct mb-2 potCount ${e.potEpic+e.potLegnd>0?"show":""}">항아리 : <span class="r_epic">${e.potEpic}</span> / <span class="r_legnd">${e.potLegnd}</span></span>\n            <span class="card-text small">최근 업데이트</span>\n            <span class="card-text small da">${null==e.uptime?"-":e.uptime}</span>\n          </div>\n        </div>`,a+=parseInt(e.epic),t+=parseInt(e.begin),r+=parseInt(e.potEpic),$("#characterList").append(s)}catch(e){console.log(e)}}),$("#advenResult").addClass("show"),loadingToggle(!1)}catch(e){loadingToggle(!1),console.log(e)}}function searchAll(e,a,t){try{let r={cName:encodeURIComponent(a)};$.ajax({url:api+"/search/"+e,type:"get",timeout:6e4,processData:!0,beforeSend:function(e){e.setRequestHeader("Content-type","application/json;charset=UTF-8"),e.setRequestHeader("gear","dfgear")},data:r,success:function(e,a,r){t(e,null)},error:function(e,a){t(e,a)}})}catch(e){sessionStorage.clear(),console.log(e)}}function getAggregate(){let e=localStorage.getItem("aggregate");if(null!=e)try{let a=JSON.parse(e);a.update<=moment().subtract(15,"m").format("YYYYMMDDTHHmm")?$.ajax({url:api+"/mistGearAggregate",type:"get",timeout:3e4,processData:!0,beforeSend:function(e){e.setRequestHeader("Content-type","application/json;charset=UTF-8"),e.setRequestHeader("gear","dfgear")},success:function(e,a,t){try{sessionStorage.setItem("serverState","1"),setAggregate(e),localStorage.setItem("aggregate",JSON.stringify(e))}catch(e){console.error(e)}},error:function(e,a){clearInterval(aggreInterval),apioff=!0,sessionStorage.setItem("serverState","0"),toast("danger","통계를 불러오는데 실패했습니다.")}}):setAggregate(a)}catch(e){console.error(e)}else $.ajax({url:api+"/mistGearAggregate",type:"get",timeout:15e3,processData:!0,beforeSend:function(e){e.setRequestHeader("Content-type","application/json;charset=UTF-8"),e.setRequestHeader("gear","dfgear")},success:function(e,a,t){try{sessionStorage.setItem("serverState","1"),setAggregate(e),localStorage.setItem("aggregate",JSON.stringify(e))}catch(e){console.error(e)}},error:function(e,a){clearInterval(aggreInterval),apioff=!0,sessionStorage.setItem("serverState","0"),toast("danger","통계를 불러오는데 실패했습니다.")}})}function setAggregate(e){try{if($("#channelList > li.chName").remove(),e.topChannel.forEach((e,a)=>{a<5?$("#channelList").append(`<li class="list-group-item side somepd chName">TOP ${a+1} <h6 id="top${a+1}c">${e.replace("_"," Ch.")}</h6></li>`):$("#channelList").append(`<li class="list-group-item side somepd chName more">TOP ${a+1} <h6 id="top${a+1}c">${e.replace("_"," Ch.")}</h6></li>`)}),$("#dailyGrade").html(`${e.grade.name}`),$("#dailyCount").html(`오늘은 ${e.dailyCount}개`),0==e.dailyCount&&$("#dailyBeginTitle").text("태초가 많이 나온 채널"),$("#maxCount").html(`${e.maxCount}개 가지고 있습니다.`),e.topBegin&&e.topBegin.length>0&&($("#beginList > *").remove(),e.topBegin.forEach((e,a)=>{$("#beginList").append(`<li class="list-group-item somepd"><img src="https://img-api.neople.co.kr/df/items/${e.itemId}">${e.itemName} <span class="badge bg-warning rounded-pill">${e.cnt}</span></li>`)})),e.beginMap&&e.beginMap.length>0){let a=["#5EC273","#9ECD6B","#D5D670","#FFDD82","#C4A64E","#999999"],t=[],r=[];e.beginMap.forEach(e=>{t.push(5==e.begin?"5개 이상":`${e.begin}개`),r.push(e.cnt)}),beginMapChart=makeChart("chart_beginMap","pie","태초 획득분포",t,r,a,beginMapChart)}}catch(e){console.error(e)}}function channelPick(){$.ajax({url:api+"/channelPick",type:"get",timeout:1e4,processData:!0,beforeSend:function(e){e.setRequestHeader("Content-type","application/json;charset=UTF-8"),e.setRequestHeader("gear","dfgear")},success:function(e,a,t){try{if(""!==e.channelName){let a=e.channelName.split("_");alert(`지금은 ${a[0]} ${a[1]} 채널로 가보세요`)}else alert("지금은 태초가 많이 집계되지 않아 추천해주기 어려워요")}catch(e){console.error(e),alert("지금은 태초가 많이 집계되지 않아 추천해주기 어려워요")}},error:function(e,a){toast("danger","추천 채널픽을 불러오는데 실패했습니다.")}})}$(document).ready(function(){nowDate=moment().format("YYYYMMDDTHHmm");try{serverId=new URLSearchParams(location.search).get("sId")?new URLSearchParams(location.search).get("sId"):sessionStorage.getItem("sId"),characterName=new URLSearchParams(location.search).get("cName")?new URLSearchParams(location.search).get("cName"):sessionStorage.getItem("cName"),sessionStorage.clear(),null!=characterName&&""!==characterName&&null!=serverId&&($("select[name='server']").val(serverId),$("input[name='name']").val(characterName),("adventure"==serverId||serverList.includes(serverId))&&Search()),history.replaceState({},null,location.pathname)}catch(e){console.log(e),history.replaceState({},null,location.pathname),$("select[name='server']").val(""),$("input[name='name']").val(""),sessionStorage.clear()}try{let e=localStorage.getItem("recent");e=null!=e?JSON.parse(e):[],e.length>0&&($(".recentBox").addClass("active"),recentView(e))}catch(e){$(".recentBox").removeClass("active")}$("#characterName").keyup(function(){13==window.event.keyCode&&Search()}),$("#characterName").focus(function(e){if($(".recentBox").hasClass("active"))return;let a=localStorage.getItem("recent");a=null!=a?JSON.parse(a):[],a.length>0&&($(".recentBox").addClass("active"),recentView(a))}),$(document).on("click","#btn_search",function(){Search()}),$(document).on("click","#btn_lightmode",function(e){ligthModeChange(e.target)}),$(document).on("click","#advenTotal",function(){if("adventure"!=$("select[name='server']").val())return;var e=$("input[name='name']").val();let a=`https://dfgear.xyz/?sId=adventure&cName=${encodeURIComponent(e)}`;navigator.clipboard.writeText(a).then(()=>{toast("info","링크 복사됨")}).catch(e=>{console.log("Something went wrong",e)})}),$(document).on("click",".row.title",function(){$("input[name='name']").val(""),loadingToggle(!1),$(".resultData").removeClass("show"),$("#characterList").html(""),$("#advenResult").removeClass("show"),$("#btn_mistList").removeClass("show")}),$(document).on("click","#btn_mistList",function(){$(".modal-body").animate({scrollTop:0},200)}),$(document).on("click",".r-list > div > label",function(e){console.log(e);let a=$(e.target).attr("data-num");recentDelete(parseInt(a))}),$(document).on("click","#moreCh",function(){$("li.chName.more").toggleClass("show"),$("#moreCh").hasClass("fold")?($("#moreCh").text("펼치기"),$("#moreCh").removeClass("fold")):($("#moreCh").text("접기"),$("#moreCh").addClass("fold"))}),$(document).on("click","#li_channelPick",function(){channelPick()}),$(document).on("show.bs.collapse","#collapseCalc",function(e){$("#expectedDate").removeClass("show"),$("#nowStone").val("")}),$(window).resize(function(){$("#loadingScreen").css("height",$(document).height())}),getAggregate(),aggreInterval=setInterval(()=>{getAggregate()},9e5)});