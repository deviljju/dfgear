let apioff=!1,timeLineList=[];const serverList=["all","anton","bakal","cain","casillas","diregie","hilder","prey","siroco"];let aggreInterval,epicMapChart,beginMapChart,nowDate=moment().format("YYYYMMDDTHHmm"),serverId="",characterName="",characterId="";function Search(){if(apioff||"0"===sessionStorage.getItem("serverState"))return toast("warning","DFGEAR ì„œë²„ ì ê²€");var e=$("select[name='server']").val(),a=$("input[name='name']").val();return(a=a.trim()).length<1?(toast("danger","ìºë¦­í„°ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."),$("#characterName").focus()):(nowDate=moment().subtract(1,"m").format("YYYYMMDDTHHmm"),$(".resultData").removeClass("show"),$("#characterList").html(""),$("#advenResult").removeClass("show"),$("#btn_mistList").removeClass("show"),"adventure"===e?a.length>29?(toast("danger","ëª¨í—˜ë‹¨ëª…ì€ 30ìë¦¬ ì´ë‚´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”"),$("#searchBar").addClass("show"),$("#characterName").focus()):(recentApply(e,a,""),sessionStorage.setItem("cName",a),location.href=`./adventure?cName=${encodeURIComponent(a)}`):a.length>20?(toast("danger","ìºë¦­í„°ëª…ì€ 20ìë¦¬ ì´ë‚´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”"),$("#searchBar").addClass("show"),$("#characterName").focus()):serverList.includes(e)?(loadingToggle(),void searchAll(e,a,function(t,s){$("#errSearch").removeClass("show"),sessionStorage.clear(),$("#searchError").removeClass("show"),$("#searchErrorDetail").removeClass("show");try{if(s){if(loadingToggle(!1),!t.responseText)return console.log(s),console.log(t),alert("ì—ëŸ¬ ë°œìƒ");$("#searchError").text(`"${a}" ê²€ìƒ‰ ê²°ê³¼`).addClass("show"),checkError(t.responseText),$("#searchError").removeClass("show"),$("#searchErrorDetail").removeClass("show")}else{if(!t.rows||!(t.rows.length>1||"all"==e))return t.rows&&1==t.rows.length&&"all"!=e?(loadingToggle(!1),recentApply(e,a,t.rows[0].characterId),sessionStorage.clear(),sessionStorage.setItem("sId",e),sessionStorage.setItem("cName",a),sessionStorage.setItem("cId",t.rows[0].characterId),location.href="https://dfgear.xyz/character"):(loadingToggle(!1),$("#advenResult").removeClass("show"),$("#btn_mistList").removeClass("show"),$("#searchError").text(`"${a}" ê²€ìƒ‰ ê²°ê³¼`).addClass("show"),$("#searchErrorDetail").addClass("show"),$(".recentBox").removeClass("active"),toast("danger","ì¼ì¹˜í•˜ëŠ” ìºë¦­í„° ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤"));makeCardView(t.rows,!1),0==t.rows.length&&$("#errSearch").addClass("show"),$("#advenTotal").html(`${a} ì¡°íšŒ ê²°ê³¼`),recentApply(e,a,""),$(".recentBox").removeClass("active")}}catch(e){return sessionStorage.clear(),loadingToggle(!1),"NO_CHARACTER"===e?toast("danger","ì¼ì¹˜í•˜ëŠ” ìºë¦­í„° ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤"):alert("ì—ëŸ¬ ë°œìƒ")}})):(toast("danger","ì„œë²„ë¥¼ ë‹¤ì‹œ ì„ íƒí•´ì£¼ì„¸ìš”"),$("#searchBar").addClass("show"),$("select[name='server']").focus()))}function loadingToggle(e=!0){e?($("#loadingScreen").css("height",$(document).height()),$("#loadingScreen").addClass("active"),$("#btn_search").addClass("disabled")):($("#loadingScreen").removeClass("active"),$("#btn_search").removeClass("disabled"))}function makeCardView(e,a=!0){try{let a=0,t=0,s=0,r=0;$("#characterList").html(""),e.forEach(e=>{try{let n=`<div class="card characterView" data-cId="${e.characterId}" data-sId="${e.serverId}" onclick="location.href='/character?sId=${e.serverId}&cId=${e.characterId}&cName=${encodeURIComponent(e.characterName)}';">\n        <div class="raidCnt flex flex-row items-center gap-1"><img src="./static/images/raid.png"><div>${e.raidCnt||"0"}</div></div>\n        <div class="nabelCnt flex flex-row items-center gap-1"><img src="./static/images/nabel.png"><div>${e.nabelCnt||"0"}</div></div>\n        <div class="owner-position">`;e.wp&&(e.wp>=4?n+='<div class="owner-digacy">ë””ê±°ì‹œ</div>':e.wp>=2?n+='<div class="owner-legacy">íƒœê±°ì‹œ</div>':1!=e.wp&&3!=e.wp||(n+='<div class="owner-star">íƒœì´ˆì˜ë³„</div>')),e.st&&(3==e.st?n+='<div class="owner-acc">ì•…ì„¸3ì…‹</div>':2==e.st&&(n+='<div class="owner-acc enough">ì•…ì„¸2ì…‹</div>')),n+="</div>",n+=`<img src="https://img-api.neople.co.kr/df/servers/${e.serverId}/characters/${e.characterId}/" class="card-img-top" alt="...">\n          <div class="card-body"><div class="flex flex-row gap-1 items-center ho-c"><img class="g-chimg" src="./static/images/fame.png"><div class="fameNumber">${e.fame}</div></div>  `,n+=`<span class="card-text cName uselct">${e.characterName}</span>            \n          <p class="card-text jobserver">${convertServer(e.serverId)}<span></span>${e.jobGrowName}</p>`,n+=`<span class="card-text uselct be">íƒœì´ˆ íšë“ : ${e.begin}</span>\n            <span class="card-text uselct to">ì—í”½ íšë“ : ${e.epic}</span>\n            <span class="card-text uselct mi">ë ˆì „ë”ë¦¬ íšë“ : ${e.legnd}</span>\n            <span class="card-text uselct mb-1">ì‹¬ì—°:ìˆ­ë°°ì : ${e.abyss?e.abyss:"-"}</span>`,n+=`<span class="card-text uselct mb-2 potCount ${e.potBegin+e.potEpic+e.potLegnd>0?"show":""}">í•­ì•„ë¦¬ : <span class="r_begin">${e.potBegin}</span> / <span class="r_epic">${e.potEpic}</span> / <span class="r_legnd">${e.potLegnd}</span></span>\n            <span class="card-text small">ìµœê·¼ ì—…ë°ì´íŠ¸</span>\n            <span class="card-text small da">${null==e.uptime?"-":e.uptime}</span>\n          </div>\n        </div>`,a+=parseInt(e.epic),t+=parseInt(e.begin),s+=parseInt(e.potBegin),r+=parseInt(e.potEpic),$("#characterList").append(n)}catch(e){console.log(e)}}),$("#advenResult").addClass("show"),loadingToggle(!1)}catch(e){loadingToggle(!1),console.log(e)}}function searchAll(e,a,t){try{let s={cName:encodeURIComponent(a)};callGearAPI("/search/"+e,s,t)}catch(e){sessionStorage.clear(),console.log(e)}}function getAggregate(){let e=localStorage.getItem("aggregate");if(null!=e)try{let a=JSON.parse(e);a.update<=moment().subtract(15,"m").format("YYYYMMDDTHHmm")?callGearAPI("/mistGearAggregate",{},function(e,a){if(a)clearInterval(aggreInterval),apioff=!0,sessionStorage.setItem("serverState","0"),toast("danger","í†µê³„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");else try{sessionStorage.setItem("serverState","1"),setAggregate(e),localStorage.setItem("aggregate",JSON.stringify(e))}catch(e){console.error(e)}}):setAggregate(a)}catch(e){console.error(e)}else callGearAPI("/mistGearAggregate",{},function(e,a){if(a)clearInterval(aggreInterval),apioff=!0,sessionStorage.setItem("serverState","0"),toast("danger","í†µê³„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");else try{sessionStorage.setItem("serverState","1"),setAggregate(e),localStorage.setItem("aggregate",JSON.stringify(e))}catch(e){console.error(e)}})}function setAggregate(e){try{if($("#channelList > li.chName").remove(),e.topChannel.forEach((e,a)=>{a<5?$("#channelList").append(`<li class="list-group-item side somepd chName">TOP ${a+1} <h6 id="top${a+1}c">${e.replace("_"," Ch.")}</h6></li>`):$("#channelList").append(`<li class="list-group-item side somepd chName more">TOP ${a+1} <h6 id="top${a+1}c">${e.replace("_"," Ch.")}</h6></li>`)}),$("#dailyGrade").html(`${e.grade.name}`),$("#dailyCount").html(`ì˜¤ëŠ˜ì€ ${e.dailyCount}ê°œ`),0==e.dailyCount&&$("#dailyBeginTitle").text("íƒœì´ˆê°€ ë§ì´ ë‚˜ì˜¨ ì±„ë„"),$("#maxCount").html(`${e.maxCount}ê°œ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.`),e.topBegin&&e.topBegin.length>0&&($("#beginList > *").remove(),e.topBegin.forEach((e,a)=>{$("#beginList").append(`<li class="list-group-item somepd"><img src="https://img-api.neople.co.kr/df/items/${e.itemId}">${e.itemName} <span class="badge bg-warning rounded-pill">${e.cnt}</span></li>`)})),e.beginMap&&e.beginMap.length>0){let a=["#5EC273","#9ECD6B","#D5D670","#FFDD82","#C4A64E","#999999"],t=[],s=[];e.beginMap.forEach(e=>{t.push(5==e.begin?"5ê°œ ì´ìƒ":`${e.begin}ê°œ`),s.push(e.cnt)}),beginMapChart=makeChart("chart_beginMap","pie","íƒœì´ˆ íšë“ë¶„í¬",t,s,a,beginMapChart)}}catch(e){console.error(e)}}function channelPick(){callGearAPI("/channelPick",{},function(e,a){if(a)toast("danger","ì¶”ì²œ ì±„ë„í”½ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");else try{if(""!==e.channelName){let a=e.channelName.split("_");alert(`ì§€ê¸ˆì€ ${a[0]} ${a[1]} ì±„ë„ë¡œ ê°€ë³´ì„¸ìš”`)}else alert("ì§€ê¸ˆì€ íƒœì´ˆê°€ ë§ì´ ì§‘ê³„ë˜ì§€ ì•Šì•„ ì¶”ì²œí•´ì£¼ê¸° ì–´ë ¤ì›Œìš”")}catch(e){console.error(e),alert("ì§€ê¸ˆì€ íƒœì´ˆê°€ ë§ì´ ì§‘ê³„ë˜ì§€ ì•Šì•„ ì¶”ì²œí•´ì£¼ê¸° ì–´ë ¤ì›Œìš”")}})}$(document).ready(function(){nowDate=moment().format("YYYYMMDDTHHmm");try{serverId=new URLSearchParams(location.search).get("sId")?new URLSearchParams(location.search).get("sId"):sessionStorage.getItem("sId"),characterName=new URLSearchParams(location.search).get("cName")?new URLSearchParams(location.search).get("cName"):sessionStorage.getItem("cName"),sessionStorage.clear(),null!=characterName&&""!==characterName&&null!=serverId&&($("select[name='server']").val(serverId),$("input[name='name']").val(characterName),("adventure"==serverId||serverList.includes(serverId))&&Search()),history.replaceState({},null,location.pathname)}catch(e){console.log(e),history.replaceState({},null,location.pathname),$("select[name='server']").val(""),$("input[name='name']").val(""),sessionStorage.clear()}if(isBeginningOfMonth()){const e=document.getElementById("gearMenu"),a=document.createElement("li");a.className="list-group-item somepd",a.textContent="ğŸ”¥íƒœì´ˆ ë¬´ê¸° í•­ì•„ë¦¬ê¹¡ í˜„í™© ì¡°íšŒğŸ”¥",a.onclick=function(){window.location.href="https://dfgear.xyz/monthWp"},e.insertBefore(a,e.firstChild)}try{let e=localStorage.getItem("recent");e=null!=e?JSON.parse(e):[],e.length>0&&($(".recentBox").addClass("active"),recentView(e))}catch(e){$(".recentBox").removeClass("active")}$("#characterName").keyup(function(){13==window.event.keyCode&&Search()}),$("#characterName").focus(function(e){if($(".recentBox").hasClass("active"))return;let a=localStorage.getItem("recent");a=null!=a?JSON.parse(a):[],a.length>0&&($(".recentBox").addClass("active"),recentView(a))}),$(document).on("click","#btn_search",function(){Search()}),$(document).on("click","#btn_lightmode",function(e){ligthModeChange(e.target)}),$(document).on("click","#advenTotal",function(){if("adventure"!=$("select[name='server']").val())return;var e=$("input[name='name']").val();let a=`https://dfgear.xyz/?sId=adventure&cName=${encodeURIComponent(e)}`;navigator.clipboard.writeText(a).then(()=>{toast("info","ë§í¬ ë³µì‚¬ë¨")}).catch(e=>{console.log("Something went wrong",e)})}),$(document).on("click",".row.title",function(){$("input[name='name']").val(""),loadingToggle(!1),$(".resultData").removeClass("show"),$("#characterList").html(""),$("#advenResult").removeClass("show"),$("#btn_mistList").removeClass("show")}),$(document).on("click","#btn_mistList",function(){$(".modal-body").animate({scrollTop:0},200)}),$(document).on("click",".r-list > div > label",function(e){console.log(e);let a=$(e.target).attr("data-num");recentDelete(parseInt(a))}),$(document).on("click","#moreCh",function(){$("li.chName.more").toggleClass("show"),$("#moreCh").hasClass("fold")?($("#moreCh").text("í¼ì¹˜ê¸°"),$("#moreCh").removeClass("fold")):($("#moreCh").text("ì ‘ê¸°"),$("#moreCh").addClass("fold"))}),$(document).on("click","#li_channelPick",function(){channelPick()}),$(document).on("show.bs.collapse","#collapseCalc",function(e){$("#expectedDate").removeClass("show"),$("#nowStone").val("")}),$(window).resize(function(){$("#loadingScreen").css("height",$(document).height())}),getAggregate(),aggreInterval=setInterval(()=>{getAggregate()},9e5)});