let nowDate=moment().format("YYYYMMDDTHHmm"),streamerId="",apioff=!1;function Search(){if(apioff||"0"===sessionStorage.getItem("serverState"))return toast("warning","DFGEAR 서버 점검");nowDate=moment().subtract(1,"m").format("YYYYMMDDTHHmm"),loadingToggle(),$("#mistList").html(""),streamerDetail(function(e,a){try{if(sessionStorage.clear(),timeLineList=[],a){if(loadingToggle(!1),!e.responseText)return console.log(a),console.log(e),alert("에러 발생");checkError(e.responseText)}else{if(e.error)return loadingToggle(!1),$(".resultData").removeClass("show"),"APIKEY_AUTH_ERROR"==e.error.message?toast("danger","에러 발생_APIKEY오류"):"SYSTEM_INSPECT"==e.error.message?(apioff=!0,toast("danger","DNF점검")):(console.log(e),toast("danger","에러 발생_캐릭터정보오류"));if(!(e.rows.length>0))return loadingToggle(!1),$(".resultData").removeClass("show"),alert("스트리머 상세정보를 불러오는데 실패했습니다.");data_List(e)}}catch(e){return sessionStorage.clear(),console.error(e),loadingToggle(!1),$(".resultData").removeClass("show"),$("#mistList").html(""),"NO_CHARACTER"===e?toast("danger","일치하는 캐릭터 정보가 없습니다"):"NOT_FOUND_CHARACTER"===e?toast("danger","캐릭터 정보를 찾을 수 없습니다"):alert("에러 발생")}})}function loadingToggle(e=!0){e?($("#loadingScreen").css("height",$(document).height()),$("#loadingScreen").addClass("active"),$("#btn_search").addClass("disabled")):($("#loadingScreen").removeClass("active"),$("#btn_search").removeClass("disabled"))}function makeCardView(e){try{$(".characterView").html(""),characterId=e.characterId,$(".characterView").attr("data-cId",e.characterId),$(".characterView").attr("data-sId",e.serverId);let a=`<span class="famehigh">명성이 가장 높은 캐릭터</span><img src="https://img-api.neople.co.kr/df/servers/${e.serverId}/characters/${e.characterId}/" class="card-img-top" alt="...">\n      <div class="card-body"><div class="flex flex-row gap-1 items-center ho-c"><img class="g-chimg" src="./static/images/fame.png"><div class="fameNumber">${e.fame}</div></div>  \n       <span id="cName" class="card-text uselct">${e.characterName}</span>          \n          <div style="text-align: -webkit-center"><p id="aName" class="card-text uselct" style="width:max-content;margin-bottom: 1rem !important;">${e.adventureName}</p></div>`;a+=`<span class="card-text uselct">태초 획득 : ${e.begin}</span>\n          <span class="card-text uselct">에픽 획득 : ${e.epic}</span>          \n          <span class="card-text uselct">레전더리 획득 : ${e.legnd}</span>\n          <span class="card-text uselct mb-1">심연:숭배자 : ${e.abyss?e.abyss:"-"}</span>\n          <span class="card-text uselct mb-2 potCount ${e.potBegin+e.potEpic+e.potLegnd>0?"show":""}">항아리 : <span class="r_begin">${e.potBegin}</span> / <span class="r_epic">${e.potEpic}</span> / <span class="r_legnd">${e.potLegnd}</span></span>\n          <span class="card-text small">최근 업데이트</span>\n          <span class="card-text small mb-1">${moment(e.updatedAt).format("YYYY-MM-DD HH:mm:ss")}</span>\n          <a href="https://dundam.xyz/character?server=${e.serverId}&key=${e.characterId}" target="_blank"><img src="https://dundam.xyz/007.png" alt="던담 바로가기" style="height:2.375rem; border-radius: 0.5em;"/></a>\n        </div>`,$(".characterView").append(a)}catch(e){console.log(e)}}function data_List(e){let a="";try{let t=[e.channelType];if(t=e.channelType.indexOf(";")?e.channelType.split(";"):[e.channelType],t.forEach(e=>{$(`#svg_${e}`).removeClass("hidden")}),a=channelConvert(t[0]),$(`#svg_${t[0]}`).css("order","3"),e.imgUrl&&e.imgUrl.length>0&&$("#stmImg").attr("src",e.imgUrl),e.otherCnId&&e.otherCnId.length>0){let a=e.otherCnId.split(";");if(t.length==a.length+1){t.slice(1,3).forEach((e,t)=>{$(`#svg_${e}`).addClass("click-pointer"),$(`#svg_${e}`).on("click",s=>{let n=channelConvert(e)+a[t];window.open(n,"_blank")})})}}}catch(e){console.log(e)}$("#advName").text(e.adventureName),$("#chName").text(e.stmName),$("#chName").on("click",t=>{let s=a+e.channelId;window.open(s,"_blank")});let t='<div class="card-header legacy">태거시 리스트</div><ul class="list-group list-group-flush">',s='<div class="card-header begin">태초 리스트</div><ul class="list-group list-group-flush">',n='<div class="card-header potList">항아리 리스트</div><ul class="list-group list-group-flush pots">',r="",l="",c={legacy:0,begin:0,epic:0,legnd:0,pot:0,cardLB:0,cardB:0,potLB:0,potB:0,transB:0,transLB:0,potEpic:0,potLegnd:0,abyss:0};try{e.timeline.forEach((a,t)=>{let n="",l="";if(a.sp&&(n="abyss"),a.advtIn&&(l="advt-in"),"태초"==a.itemRarity)if(null==a.itemType||0==e.legacy.length)515==a.code||516==a.code?(c.transB++,r+=`<li class="list-group-item ${n}" title="${moment(a.date).format("YYYY-MM-DD HH:mm")}">\n            <dd>-</dd>\n            <div class="smallIcon ${a.jobCss}" style="background-image: url('https://img-api.neople.co.kr/df/servers/${a.serverId}/characters/${a.characterId}?zoom=1');"></div>\n            <p class="${l}" tabindex="0" data-title="${moment(a.date).format("YYYY-MM-DD HH:mm")}"><img src="https://img-api.neople.co.kr/df/items/${a.itemId}">${a.itemName}</p>\n            <span class="badge bg-warning rounded-pill" title="${a.channel}">초월</span></li>`):(c.begin++,s+=`<li class="list-group-item ${n}" title="${moment(a.date).format("YYYY-MM-DD HH:mm")}">\n            <dd>${c.begin}</dd>\n            <div class="smallIcon ${a.jobCss}" style="background-image: url('https://img-api.neople.co.kr/df/servers/${a.serverId}/characters/${a.characterId}?zoom=1');"></div>\n            <p class="${l}" tabindex="0" data-title="${moment(a.date).format("YYYY-MM-DD HH:mm")}${505!=a.code?", "+a.channel:""}"><img src="https://img-api.neople.co.kr/df/items/${a.itemId}">${a.itemName}</p>`,504==a.code?(c.potB++,s+=' <span class="badge bg-warning rounded-pill">항아리&상자</span>'):507==a.code?(c.cardB++,s+=` <span class="badge bg-warning rounded-pill" title="${a.channel}">레이드</span>`):513==a.code&&(c.cardB++,s+=` <span class="badge bg-warning rounded-pill" title="${a.channel}">카드</span>`),s+="</li>");else{let t;for(leg of e.legacy)if(a.characterId==leg.characterId&&a.itemName==leg.itemName){t=leg;break}null==t&&(515==a.code||516==a.code?(c.transB++,r+=`<li class="list-group-item ${n}" title="${moment(a.date).format("YYYY-MM-DD HH:mm")}">\n              <dd>-</dd>\n              <div class="smallIcon ${a.jobCss}" style="background-image: url('https://img-api.neople.co.kr/df/servers/${a.serverId}/characters/${a.characterId}?zoom=1');"></div>\n              <p class="${l}" tabindex="0" data-title="${moment(a.date).format("YYYY-MM-DD HH:mm")}${505!=a.code?", "+a.channel:""}"><img src="https://img-api.neople.co.kr/df/items/${a.itemId}">${a.itemName}</p>\n              <span class="badge bg-warning rounded-pill" title="${a.channel}">초월</span></li>`):(c.begin++,s+=`<li class="list-group-item ${n}" title="${moment(a.date).format("YYYY-MM-DD HH:mm")}">\n              <dd>${c.begin}</dd>\n              <div class="smallIcon ${a.jobCss}" style="background-image: url('https://img-api.neople.co.kr/df/servers/${a.serverId}/characters/${a.characterId}?zoom=1');"></div>\n              <p class="${l}" tabindex="0" data-title="${moment(a.date).format("YYYY-MM-DD HH:mm")}${505!=a.code?", "+a.channel:""}"><img src="https://img-api.neople.co.kr/df/items/${a.itemId}">${a.itemName}</p>`,504==a.code?(c.potB++,s+=' <span class="badge bg-warning rounded-pill">항아리&상자</span>'):507==a.code?(c.cardB++,s+=` <span class="badge bg-warning rounded-pill" title="${a.channel}">레이드</span>`):513==a.code&&(c.cardB++,s+=` <span class="badge bg-warning rounded-pill" title="${a.channel}">카드</span>`),s+="</li>"))}}),e.legacy.forEach((e,a)=>{if(null!=e.itemType){let a="",s="";e.sp&&(a="abyss"),e.advtIn&&(s="advt-in"),515==e.code||516==e.code?(c.transLB++,l+=`<li class="list-group-item ${a}" title="${moment(e.date).format("YYYY-MM-DD HH:mm")}">\n          <dd>-</dd>\n          <div class="smallIcon ${e.jobCss}" style="background-image: url('https://img-api.neople.co.kr/df/servers/${e.serverId}/characters/${e.characterId}?zoom=1');"></div>\n          <p class="${s}" tabindex="0" data-title="${moment(e.date).format("YYYY-MM-DD HH:mm")}"><img src="https://img-api.neople.co.kr/df/items/${e.itemId}">${e.itemName}</p>\n          <span class="badge bg-warning rounded-pill" title="${e.channel}">초월</span></li>`):(c.legacy++,t+=`<li class="list-group-item ${a}" title="${moment(e.date).format("YYYY-MM-DD HH:mm")}">\n          <dd>${c.legacy}</dd>\n          <div class="smallIcon ${e.jobCss}" style="background-image: url('https://img-api.neople.co.kr/df/servers/${e.serverId}/characters/${e.characterId}?zoom=1');"></div>\n          <p class="${s}" tabindex="0" data-title="${moment(e.date).format("YYYY-MM-DD HH:mm")}${505!=e.code?", "+e.channel:""}"><img src="https://img-api.neople.co.kr/df/items/${e.itemId}">${e.itemName}</p>`,504==e.code?(c.potLB++,t+=' <span class="badge bg-warning rounded-pill">항아리&상자</span>'):507==e.code?(c.cardLB++,t+=` <span class="badge bg-warning rounded-pill" title="${e.channel}">레이드</span>`):513==e.code&&(c.cardLB++,t+=` <span class="badge bg-warning rounded-pill" title="${e.channel}">카드</span>`),t+="</li>")}}),n+="</ul>",timeLineList=e.timeline,c.begin+c.transB>0?(r.length>0&&(s+=r),s+="</ul>"):s+='<li class="list-group-item"> 나만 운없어 </li></ul>',c.legacy+c.transLB>0&&(l.length>0&&(t+=l),t+="</ul>",$("#mistList").append(t)),$("#mistList").append(s),c.pot>0&&$("#mistList").append(n),$(".resultData").addClass("show");let a={begin:0};if(""!=e.summary&&void 0!==e.summary.legnd?(c.epic=e.summary.epic,c.legnd=e.summary.legnd,c.potEpic=e.summary.potEpic,c.potLegnd=e.summary.potLegnd,c.abyss=e.summary.abyss,a=e.summary.many):e.rows.forEach(e=>{c.epic+=e.epic,c.legnd+=e.legnd,c.potEpic+=e.potEpic,c.potLegnd+=e.potLegnd,c.abyss+=e.abyss,e.begin>a.begin&&(a=e)}),$("#totalB").text(c.begin+c.legacy-c.potB-c.potLB),$("#dropB").text(`드랍:${c.begin+c.legacy-c.cardB-c.cardLB-c.potB-c.potLB}개`),$("#cardB").text(`카드:${c.cardB+c.cardLB}개`),$("#potB").text(`항아리:${c.potB+c.potLB}개`),$("#transB").text(`초월:${c.transB+c.transLB}개`),$("#totalE").text(c.epic),$("#totalL").text(c.legnd),$("#totalPe").text(c.potEpic),$("#totalPl").text(c.potLegnd),$("#totalAbyss").text(c.abyss),$("#lucky > div").css("background-image",`url('https://img-api.neople.co.kr/df/servers/${a.serverId}/characters/${a.characterId}?zoom=1')`),$("#lucky > div").addClass(a.jobCss),$("#lk_name").text(a.characterName),$("#lk_name").on("click",e=>{let t=`https://dfgear.xyz/character?sId=${a.serverId}&cId=${a.characterId}&cName=${a.characterName}`;window.open(t,"_self")}),c.begin+c.legacy>0&&(0==c.epic?$("#b_rate").text("(1.00)"):$("#b_rate").text(`(${((c.begin+c.legacy-c.potB-c.potLB)/c.epic).toFixed(3)})`)),$("#channels > div").remove(),e.channel&&e.channel.length>0)for(var o of($("#channels").removeClass("hidden"),e.channel=e.channel.slice(0,5),e.channel))$("#channels").append(`<div><h4 id="ch1">${o.cn}</h4><h5 id="ch1cnt">${o.cnt}개</h5></div>`);else $("#channels").addClass("hidden")}catch(e){console.error(e)}makeCardView(e.rows[0]),loadingToggle(!1)}function streamerDetail(e){try{callGearAPI("/strm/detail/"+streamerId,{id:streamerId},e)}catch(e){sessionStorage.clear(),console.log(e)}}function channelConvert(e){return"ch"==e?"https://chzzk.naver.com/":"so"==e?"https://ch.sooplive.co.kr/":"yt"==e?"https://www.youtube.com/":void 0}$(document).ready(function(){$(document).on("click","#btn_lightmode",function(e){ligthModeChange(e.target)}),$(document).on("click",".row.title",function(){try{location.href="./"}catch(e){sessionStorage.clear(),location.href="https://dfgear.xyz"}}),$(document).on("click",".potList",function(){$(".card-header.potList").hasClass("open")?($(".card-header.potList").removeClass("open"),$("ul.pots").removeClass("show")):($(".card-header.potList").addClass("open"),$("ul.pots").addClass("show"))}),$(document).on("click","#aName",function(e){return sessionStorage.setItem("sId","adventure"),sessionStorage.setItem("cName",$(e.target).text()),location.href=`https://dfgear.xyz/adventure?cName=${encodeURIComponent($(e.target).text())}`}),$(window).resize(function(){$("#loadingScreen").css("height",$(document).height())});try{streamerId=new URLSearchParams(location.search).get("id")||sessionStorage.getItem("strmId")||"",""==streamerId||null===streamerId?(alert("스트리머 정보를 다시 선택해주세요"),sessionStorage.clear(),location.href="https://dfgear.xyz/streamer"):Search()}catch(e){alert("스트리머 정보를 다시 선택해주세요"),sessionStorage.clear(),location.href="https://dfgear.xyz/streamer"}});