let debounceTimer,timeLineList=[],potList=[],nowDate=moment().format("YYYYMMDDTHHmm"),serverId="",characterId="",characterName="",isHideOption=!0,apioff=!1,isRecent=!1;function Search(e=""){return apioff||"0"===sessionStorage.getItem("serverState")?toast("warning","DFGEAR 서버 점검"):($("#searchBar").hasClass("show")&&(serverId=$("select[name='server']").val(),characterName=$("input[name='name']").val(),characterName=characterName.trim(),characterId="",$("#equipList").removeClass("show"),$("#setList").removeClass("show"),isHideOption=!0),characterName.length<1&&""===e?(toast("danger","캐릭터명을 입력해주세요"),$("#searchBar").addClass("show"),$("#characterName").focus()):"adventure"===serverId?characterName.length>29?(toast("danger","모험단명은 30자리 이내로 입력해주세요"),$("#searchBar").addClass("show"),$("#characterName").focus()):(sessionStorage.setItem("cName",characterName),location.href=`./adventure?cName=${encodeURIComponent(characterName)}`):"all"===serverId?(sessionStorage.setItem("sId",serverId),sessionStorage.setItem("cName",characterName),location.href="./"):characterName.length>20?(toast("danger","캐릭터명은 20자리 이내로 입력해주세요"),$("#searchBar").addClass("show"),sessionStorage.clear(),$("#characterName").focus()):(nowDate=moment().subtract(1,"m").format("YYYYMMDDTHHmm"),loadingToggle(),$(".resultData").removeClass("show"),$(".gear-list").html(""),$("#timelineList > *").remove(),$("#potList > *").remove(),$("#setInfo *").remove(),$("table.summary").removeClass("show"),void searchCharacterTimeline(serverId,characterName,nowDate,e,function(e,t){try{if(sessionStorage.clear(),$("#searchBar").addClass("show"),$("#searchError").removeClass("show"),timeLineList=[],t){if(loadingToggle(!1),$("#btn_epicList").removeClass("show"),$(".resultData").removeClass("show"),$(".gear-list").html(""),!e.responseText)return console.log(t),console.log(e),alert("에러 발생");$("#searchError").text(`"${characterName}" 검색 결과`).addClass("show"),checkError(e.responseText)}else{if(e.error)return loadingToggle(!1),$("#btn_epicList").removeClass("show"),$(".resultData").removeClass("show"),$(".gear-list").html(""),$("#searchError").text(`"${characterName}" 검색 결과`).addClass("show"),"APIKEY_AUTH_ERROR"==e.error.message?toast("danger","에러 발생_APIKEY오류"):"SYSTEM_INSPECT"==e.error.message?(apioff=!0,toast("danger","DNF점검")):(console.log(e),toast("danger","에러 발생_캐릭터정보오류"));if(e.rows.length>1)return sessionStorage.setItem("sId",serverId),sessionStorage.setItem("cName",characterName),location.href="./";if(1!=e.rows.length)return loadingToggle(!1),$("#btn_epicList").removeClass("show"),$(".resultData").removeClass("show"),$(".gear-list").html(""),$("#searchError").text(`"${characterName}" 검색 결과`).addClass("show"),toast("danger","일치하는 캐릭터 정보가 없습니다");data_List(e),isRecent&&(recentApply(serverId,characterName,e.rows[0].characterId),isRecent=!1)}}catch(e){return sessionStorage.clear(),console.error(e),loadingToggle(!1),$("#btn_epicList").removeClass("show"),$("#searchBar").addClass("show"),$(".resultData").removeClass("show"),$(".gear-list").html(""),$("#searchError").text(`"${characterName}" 검색 결과`).addClass("show"),"NO_CHARACTER"===e?toast("danger","일치하는 캐릭터 정보가 없습니다"):"NOT_FOUND_CHARACTER"===e?toast("danger","캐릭터 정보를 찾을 수 없습니다"):alert("에러 발생")}})))}function loadingToggle(e=!0){e?($("#loadingScreen").css("height",$(document).height()),$("#loadingScreen").addClass("active"),$("#btn_search").addClass("disabled")):($("#loadingScreen").removeClass("active"),$("#btn_search").removeClass("disabled"))}function makeCardView(e){try{$(".characterView").html(""),characterId=e.characterId,$(".characterView").attr("data-cId",e.characterId),$(".characterView").attr("data-sId",e.serverId);let t=`<div class="raidCnt flex flex-row items-center gap-1"><img src="./static/images/raid.png"><div>${e.raidCnt}</div></div>\n                <div class="nabelCnt flex flex-row items-center gap-1"><img src="./static/images/nabel.png"><div>${e.nabelCnt}</div></div>`;if(e.wp&&(t+='<div class="owner-position">',e.wp>=2&&(t+='<div class="owner-legacy">태거시</div>'),1!=e.wp&&3!=e.wp||(t+='<div class="owner-star">태초의별</div>'),t+="</div>"),t+=`<img src="https://img-api.neople.co.kr/df/servers/${e.serverId}/characters/${e.characterId}?zoom=4" class="card-img-top" alt="...">\n        <div class="card-body"><div class="flex flex-row gap-1 items-center ho-c"><img class="g-chimg" src="./static/images/fame.png"><div class="fameNumber">${e.fame}</div></div>  \n        <span id="cName" class="card-text uselct">${e.characterName}</span>\n          <div style="text-align: -webkit-center"><p id="aName" class="card-text uselct" style="width:max-content;margin-bottom: 1rem !important;">${e.adventureName}</p></div>`,e.many>0)try{let a=e.many/e.rankingTotal*100,s=e.lucky/e.rankingTotal*100;if(a=a>100?100:a.toFixed(2),s<61&&e.epic>5){s=s.toFixed(2),t+=`<p class="card-text uselct rank mb-0" title="기린점수:${(e.pt/1e4).toFixed(3)}">기린 랭킹 : ${numberFmt(e.lucky)}위(상위 ${s}%)</p>`}t+=`<p class="card-text uselct rank mb-1">획득 랭킹 : ${numberFmt(e.many)}위(상위 ${a}%)</p>`}catch(e){console.log(e)}t+=`<span class="card-text uselct">태초 획득 : ${e.begin}</span>\n          <span class="card-text uselct">에픽 획득 : ${e.epic}</span>\n          <span class="card-text uselct">레전더리 획득 : ${e.legnd}</span>\n          <span class="card-text uselct mb-1">심연:숭배자 : ${e.abyss?e.abyss:"-"}</span>\n          <span class="card-text uselct mb-2 potCount ${e.potEpic+e.potLegnd>0?"show":""}">항아리 : <span class="r_epic">${e.potEpic}</span> / <span class="r_legnd">${e.potLegnd}</span></span>\n          <span class="card-text small">최근 업데이트</span>\n          <span class="card-text small mb-1">${moment().format("YYYY-MM-DD HH:mm:ss")}</span>\n          <a href="https://dundam.xyz/character?server=${e.serverId}&key=${e.characterId}" target="_blank"><img src="https://dundam.xyz/007.png" alt="던담 바로가기" style="height:2.375rem; border-radius: 0.5em;"/></a>\n          <div class="btn-hide"><p id="openHide" class="card-text uselct" data-bs-toggle="modal" data-hide="${e.isHide?"0":"1"}" data-bs-target="#hideModal" aria-controls="hideModal">${e.isHide?"표시하기":"숨기기"}</p></div>\n        </div>`,e.isHide?($("#btn_chracterShow").removeClass("hidden"),$("#btn_chracterHide").addClass("hidden"),$("#txt_showDesc").removeClass("hidden"),$("#txt_hideDesc").addClass("hidden")):($("#btn_chracterShow").addClass("hidden"),$("#btn_chracterHide").removeClass("hidden"),$("#txt_showDesc").addClass("hidden"),$("#txt_hideDesc").removeClass("hidden")),$(".characterView").append(t),e.equipment&&e.equipment.length>0?($("#equipList").addClass("show"),$("#equipment > div img").attr("src","./static/images/cancel.png"),e.equipment.forEach(e=>{$(`#${e.slotId}`).attr("src",`https://img-api.neople.co.kr/df/items/${e.itemId}`);let t=e.eqPlus||0,a=e.upgrade?e.upgrade.p:0;t+a>0&&$(`#${e.slotId}`).attr("title",`융합석:${a},조율:${10*t}`)})):$("#equipList").removeClass("show"),e.abyss&&e.abyss>0?($("#abyss").addClass("show"),$("#absTotal").text(e.abyss),e.absBegin||(e.absBegin=0),$("#absBegin").text(e.absBegin),e.absEpic||(e.absEpic=0),$("#absEpic").text(e.absEpic),e.absLegnd||(e.absLegnd=0),$("#absLegnd").text(e.absLegnd)):$("#abyss").removeClass("show")}catch(e){console.log(e)}}function data_List(e){let t=[],a={},s="";e.timeline.forEach((e,s)=>{e.dungeonName&&"심연 : 종말의 숭배자"==e.dungeonName&&(e.abyss=!0),"에픽"==e.itemRarity?t.push({code:e.code,itemName:e.itemName,get:e.channel,date:e.date,itemId:e.itemId,r:"e",advtMove:e.advtMove,abyss:e.abyss}):"태초"==e.itemRarity&&t.push({code:e.code,itemName:e.itemName,get:e.channel,date:e.date,itemId:e.itemId,r:"b",advtMove:e.advtMove,abyss:e.abyss}),null!=e.detail.setItemName&&""!=e.detail.setItemName?null==a[e.detail.setItemName]?a[e.detail.setItemName]=[{code:e.code,date:e.date,itemName:e.itemName,itemId:e.itemId,itemRarity:e.detail.itemRarity,r:changeorderKey("r",e.detail.itemRarity),t:changeorderKey("t",e.detail.itemType),advtMove:e.advtMove}]:a[e.detail.setItemName].push({code:e.code,date:e.date,itemName:e.itemName,itemId:e.itemId,itemRarity:e.detail.itemRarity,r:changeorderKey("r",e.detail.itemRarity),t:changeorderKey("t",e.detail.itemType),advtMove:e.advtMove}):0===e.itemName.indexOf("고유 - ")&&(null==a["고유"]?a["고유"]=[{code:e.code,date:e.date,itemName:e.itemName,itemId:e.itemId,itemRarity:e.detail.itemRarity,r:changeorderKey("r",e.detail.itemRarity)+.5,t:changeorderKey("t",e.detail.itemType),advtMove:e.advtMove}]:a["고유"].push({code:e.code,date:e.date,itemName:e.itemName,itemId:e.itemId,itemRarity:e.detail.itemRarity,r:changeorderKey("r",e.detail.itemRarity)+.5,t:changeorderKey("t",e.detail.itemType),advtMove:e.advtMove}))}),openTab("summary"),timeLineList=e.timeline,summaryListAppend(t),$(".resultData").addClass("show"),$("#searchBar").addClass("show"),e.setInfo&&e.setInfo.setItemName&&(equipSetAppend(e.setInfo),s=e.setInfo.setId||""),makeSetList(a,e.rows[0].equipment,s),loadingToggle(!1),makeCardView(e.rows[0]),$("input[name='name']").val(""),$("#timeLineItemFilter").val(""),$("#potItemFilter").val(""),$("select[name='rarity']").val("all")}function searchCharacterTimeline(e,t,a,s="",i){try{let r={sId:e,cName:encodeURIComponent(t),endDate:a,cId:s};$.ajax({url:api+"/character/v2/Timeline",type:"get",timeout:3e4,processData:!0,beforeSend:function(e){e.setRequestHeader("Content-type","application/json;charset=UTF-8"),e.setRequestHeader("gear","dfgear")},data:r,success:function(e,t,a){i(e,null)},error:function(e,t){i(e,t)}})}catch(e){sessionStorage.clear(),console.log(e)}}function makeSetList(e,t=[],a=""){let s=[],i={},r={},n={},o=[];if(potList=[],"object"==typeof e){let a={partsPoint:[0,0,0,0,0,0,0,0,0,0,0],uniqItemId:["","","","","","","","","","",""],uniq:[],cnt:[0,0,0,0,0,0,0,0,0,0,0]};null!=e["고유"]&&e["고유"].length>0&&(e["고유"].forEach(e=>{let t=pointCalc(e.r);a.partsPoint[e.t-1]<t&&(a.partsPoint[e.t-1]=t,a.uniqItemId[e.t-1]=e)}),a.uniq=a.uniqItemId.filter(e=>""!=e));for(const c in e)if(e.hasOwnProperty(c)){if(n[c]={lastUPD:{date:"",itemName:"",t:"",r:""},partsPoint:[0,0,0,0,0,0,0,0,0,0,0],total:0,mainItem:[{itemRarity:"유니크",itemName:"",itemId:"",pt:0,t:1},{itemRarity:"유니크",itemName:"",itemId:"",pt:0,t:2},{itemRarity:"유니크",itemName:"",itemId:"",pt:0,t:3},{itemRarity:"유니크",itemName:"",itemId:"",pt:0,t:4},{itemRarity:"유니크",itemName:"",itemId:"",pt:0,t:5},{itemRarity:"유니크",itemName:"",itemId:"",pt:0,t:6},{itemRarity:"유니크",itemName:"",itemId:"",pt:0,t:7},{itemRarity:"유니크",itemName:"",itemId:"",pt:0,t:8},{itemRarity:"유니크",itemName:"",itemId:"",pt:0,t:9},{itemRarity:"유니크",itemName:"",itemId:"",pt:0,t:10},{itemRarity:"유니크",itemName:"",itemId:"",pt:0,t:11}],armoryItem:[],addHtml:"",armoryHtml:""},a.uniq.length>0&&"고유"!=c&&"차원 속의 이야기 세트"!=c){let t=JSON.stringify(a.uniq);e[c].push(...JSON.parse(t)),e[c]=e[c].sort((e,t)=>new Date(e.date)-new Date(t.date))}n[c].addHtml+=`<div class="card-header" id="${c.replace(/\s+/g,"")}">${c}</div><ul class="list-group list-group-flush"><li class="list-group-item setPoint ${"고유"==c?"jc-unset":""}">`,e[c].forEach(e=>{let t=pointCalc(e.r);if(504==e.code&&!e.itemName.includes("고유 -")){let a=potProbability(n[c].mainItem,e,t),s={date:e.date,itemName:e.itemName,itemRarity:e.itemRarity,t:e.t,per:a.per,res:a.vaild?"성공":"실패"};potList.push(s)}if(s.indexOf(e.itemId)<0){if(e.advtMove&&"in"==e.advtMove)return;if(e.itemName.indexOf("고유 - ")<0?(s.push(e.itemId),r[e.itemId]=1):"고유"==c&&(null==i[e.itemId]?i[e.itemId]=1:i[e.itemId]++),n[c].mainItem[e.t-1].pt<t){if(n[c].lastUPD.date<e.date&&(n[c].lastUPD.date=e.date,n[c].lastUPD.itemName=e.itemName,n[c].lastUPD.t=e.t,n[c].lastUPD.r=e.r),n[c].partsPoint[e.t-1]=t,"고유"==c&&(n[c].addHtml+=`<div class="b-${e.itemRarity}" title="${e.itemName}(${e.itemRarity})"><img class="setImg" src="https://img-api.neople.co.kr/df/items/${e.itemId}"><div id="s_${e.itemId}" class="itemCount"></div></div>`),""!=n[c].mainItem[e.t-1].itemName){const t=n[c].mainItem[e.t-1];n[c].armoryItem.push(t)}n[c].mainItem[e.t-1]={itemRarity:e.itemRarity,itemName:e.itemName,itemId:e.itemId,pt:t,r:e.r,t:e.t}}else if(n[c].mainItem[e.t-1].pt!=t||e.itemName.includes("고유 -"))e.itemName.includes("고유 -")||n[c].armoryItem.push({itemRarity:e.itemRarity,itemName:e.itemName,itemId:e.itemId,pt:t,r:e.r,t:e.t});else{if(""!=n[c].mainItem[e.t-1].itemName&&!n[c].mainItem[e.t-1].itemName.includes("고유 -")){const t=n[c].mainItem[e.t-1];n[c].armoryItem.push(t)}n[c].mainItem[e.t-1]={itemRarity:e.itemRarity,itemName:e.itemName,itemId:e.itemId,pt:t,r:e.r,t:e.t}}}else r[e.itemId]++});let m={begin:0,epic:0,legnd:0,uniq:0};if("고유"!=c){n[c].partsPoint.map((e,a)=>{if(0==e){let s=changeorderKey("det",a+1);for(item of t)if(s==item.slotId){(c==item.setName||""===item.setName&&"레어"==item.itemRarity||0===item.itemName.indexOf("고유 - "))&&(e=item.setPoint||115,n[c].partsPoint[a]=e,n[c].mainItem[a]={itemRarity:item.itemRarity,itemName:item.itemName,itemId:item.itemId,pt:e});break}return 0==e&&(n[c].total+=115),e}});let e='<div class="l1">';for(var d=0;d<5;d++){n[c].total+=n[c].mainItem[d].pt;let t="";1==d?t="p0_1":2==d?t="p1_0":3==d?t="p1_1":4==d&&(t="p2_0"),n[c].mainItem[d].itemId?n[c].mainItem[d].itemName.includes("고유")?e+=`<div class="b-${n[c].mainItem[d].itemRarity} ${t}" title="${n[c].mainItem[d].itemName}(${n[c].mainItem[d].itemRarity})"><img class="setImg" src="https://img-api.neople.co.kr/df/items/${n[c].mainItem[d].itemId}"></div>`:e+=`<div class="b-${n[c].mainItem[d].itemRarity} ${t}" title="${n[c].mainItem[d].itemName}(${n[c].mainItem[d].itemRarity})"><img class="setImg" src="https://img-api.neople.co.kr/df/items/${n[c].mainItem[d].itemId}"><div id="s_${n[c].mainItem[d].itemId}" class="itemCount"></div></div>`:e+=`<div class="b-${n[c].mainItem[d].itemRarity} ${t}" title="${n[c].mainItem[d].itemName}(${n[c].mainItem[d].itemRarity})"><div style="width: 28px; height: 28px; background-color: black;"></div></div>`}e+='</div><div class="l2 ms-3">';for(d=5;d<11;d++){let t="";n[c].total+=n[c].mainItem[d].pt,6==d?t="p0_1":7==d?t="p1_1":8==d?t="p1_0":9==d?t="p2_1":10==d&&(t="p2_0"),n[c].mainItem[d].itemId?n[c].mainItem[d].itemName.includes("고유")?e+=`<div class="b-${n[c].mainItem[d].itemRarity} ${t}" title="${n[c].mainItem[d].itemName}(${n[c].mainItem[d].itemRarity})"><img class="setImg" src="https://img-api.neople.co.kr/df/items/${n[c].mainItem[d].itemId}"></div>`:e+=`<div class="b-${n[c].mainItem[d].itemRarity} ${t}" title="${n[c].mainItem[d].itemName}(${n[c].mainItem[d].itemRarity})"><img class="setImg" src="https://img-api.neople.co.kr/df/items/${n[c].mainItem[d].itemId}"><div id="s_${n[c].mainItem[d].itemId}" class="itemCount"></div></div>`:e+=`<div class="b-${n[c].mainItem[d].itemRarity} ${t}" title="${n[c].mainItem[d].itemName}(${n[c].mainItem[d].itemRarity})"><div style="width: 28px; height: 28px; background-color: black;"></div></div>`}e+="</div>",n[c].mainItem.forEach(e=>{switch(e.itemRarity){case"태초":m.begin++;break;case"에픽":m.epic++;break;case"레전더리":m.legnd++;break;default:m.uniq++}}),e+=`<div class="l2 ms-3 rairitySummary">\n          ${m.begin>0?'<div class="set_begin"><span>태초: '+m.begin+"개</span></div>":""}\n          ${m.epic>0?'<div class="set_epic"><span>에픽: '+m.epic+"개</span></div>":""}\n          ${m.legnd>0?'<div class="set_legnd"><span>레전더리: '+m.legnd+"개</span></div>":""}\n          ${m.uniq>0?'<div class="set_uniq"><span>레전미만: '+m.uniq+"개</span></div>":""}</div>`,n[c].addHtml+=e}if(o.push({setName:c,total:n[c].total,rCnt:m}),n[c].armoryItem.length>0){let e=n[c].armoryItem.sort((e,t)=>e.t!==t.t?e.t-t.t:e.r-t.r);n[c].armoryHtml='<li class="list-group-item armory hidden">',e.forEach(e=>{n[c].armoryHtml+=`<div class="b-${e.itemRarity}" title="${e.itemName}(${e.itemRarity})"><img class="setImg" src="https://img-api.neople.co.kr/df/items/${e.itemId}"><div id="s_${e.itemId}" class="itemCount"></div></div>`}),n[c].armoryHtml+="</li></ul>",n[c].addHtml+="</li>"}else n[c].addHtml+="</li></ul>"}}if(o=o.sort((e,t)=>e.total!=t.total?t.total-e.total:e.rCnt.begin!=t.rCnt.begin?t.rCnt.begin-e.rCnt.begin:e.rCnt.epic!=t.rCnt.epic?t.rCnt.epic-e.rCnt.epic:t.rCnt.legnd-e.rCnt.legnd),o.length>0){$("#setList").addClass("show"),$("#h_specTime").text("");let e="";if(e=setJson[o[0].setName]==a?o[0].setName:setJson[a]&&n[setJson[a]]?setJson[a]:o[0].setName,n[e]){let t=n[e].mainItem.filter(e=>e.t>5&&e.t<9&&e.pt<265||(e.t<6||e.t>9)&&e.pt<215);e!=o[0].setName?(lastUpAppend([n[e].lastUPD,n[o[0].setName].lastUPD]),$("#equipSpecDiv > table").addClass("show")):t.length>0?(lastUpAppend([n[e].lastUPD]),$("#equipSpecDiv > table").addClass("show")):$("#h_specTime").text("")}}else $("#setList").removeClass("show");$("#setItem *").remove(),$("#setItem").append('<div id="filter_item" class="card-header"><div class="form-check form-switch" title="레전더리 장비 필터링"><input class="form-check-input" type="checkbox" role="switch" id="ft_legnd" checked>\n                    <label class="form-check-label" for="ft_legnd">레전 표시</label></div><div class="form-check form-switch" title="세트포인트에 계산되지 않는 하위 등급 장비 필터링"><input class="form-check-input" type="checkbox" role="switch" id="ft_armory">\n                    <label class="form-check-label" for="ft_armory">무기고 표시</label></div></div>'),o.forEach(e=>{if(n[e.setName].armoryHtml.length>0){let t=n[e.setName].addHtml+n[e.setName].armoryHtml;$("#setItem").append(t)}else $("#setItem").append(n[e.setName].addHtml);$(`#setItem > #${e.setName.replace(/\s+/g,"")}`).text(`${e.setName} (pt:${e.total}+@)`)});for(const e in r)r[e]>1&&$(`#s_${e}`).text(`x${r[e]}`);for(const e in i)i[e]>1&&$(`#s_${e}`).text(`x${i[e]}`)}function checkRequest(e){try{let t={sId:serverId,cId:characterId,isHide:e};loadingToggle(),$.ajax({url:api+"/character/v2/statusReq",type:"get",timeout:3e4,processData:!0,beforeSend:function(e){e.setRequestHeader("Content-type","application/json;charset=UTF-8"),e.setRequestHeader("gear","dfgear")},data:t,success:function(e,t,a){loadingToggle(!1),e.slotId&&($("#emptySlot").text(convertSlot(e.slotId)),$("#targetSlot").attr("src",$(`#${e.slotId}`).attr("src"))),isHideOption=!1},error:function(e,t){if(loadingToggle(!1),!e.responseText)return console.log(t),console.log(e),alert("에러 발생");checkError(e.responseText)}})}catch(e){sessionStorage.clear(),console.log(e)}}function hideCharacter(e){try{let t={sId:serverId,cId:characterId,isHide:e};loadingToggle(),$.ajax({url:api+"/character/v2/status",type:"get",timeout:3e4,processData:!0,beforeSend:function(e){e.setRequestHeader("Content-type","application/json;charset=UTF-8"),e.setRequestHeader("gear","dfgear")},data:t,success:function(e,t,a){return loadingToggle(!1),e.code&&"HIDE_SUCCESS"==e.code?($("#hideModal").modal("hide"),toast("info","모험단 검색의 캐릭터 리스트에서 숨김처리 되었습니다")):e.code&&"SHOW_SUCCESS"==e.code?($("#hideModal").modal("hide"),toast("info","모험단 검색의 캐릭터 리스트에서 표시처리 되었습니다")):e.code&&"SLOT_NOT_EMPTY"==e.code?alert("위 장비가 해제되지 않은 것 같습니다. 캐릭터 변경 후 다시 시도해주세요."):void(isHideOption=!1)},error:function(e,t){if(loadingToggle(!1),!e.responseText)return console.log(t),console.log(e),alert("에러 발생");checkError(e.responseText)}})}catch(e){sessionStorage.clear(),console.log(e)}}function changeorderKey(e,t){if("t"==e)switch(t){case"머리어깨":return 1;case"상의":return 2;case"하의":return 3;case"벨트":return 4;case"신발":return 5;case"팔찌":return 6;case"목걸이":return 7;case"반지":return 8;case"보조장비":return 9;case"마법석":return 10;case"귀걸이":return 11;default:return 99}else if("r"==e)switch(t){case"태초":return 1;case"에픽":return 2;case"레전더리":return 3;default:return 99}else if("det"==e)switch(t){case 1:return"SHOULDER";case 2:return"JACKET";case 3:return"PANTS";case 4:return"WAIST";case 5:return"SHOES";case 6:return"WRIST";case 7:return"AMULET";case 8:return"RING";case 9:return"SUPPORT";case 10:return"MAGIC_STON";case 11:return"EARRING";default:return""}}function convertSlot(e){try{switch(e){case"SHOULDER":return"머리어깨";case"JACKET":return"상의";case"PANTS":return"하의";case"WAIST":return"벨트";case"SHOES":return"신발";case"WRIST":return"팔찌";case"AMULET":return"목걸이";case"RING":return"반지";case"SUPPORT":return"보조장비";case"MAGIC_STON":return"마법석";case"EARRING":return"귀걸이";default:return"모든 장비"}}catch(e){console.log(e)}}function pointCalc(e){try{switch(e){case 1:case 1.5:return 265;case 2:case 2.5:return 215;case 3:case 3.5:return 165;default:return 0}}catch(e){return console.error(e),0}}function openTab(e){const t=document.querySelectorAll(".tab"),a=document.querySelectorAll(".tab-content");if(t.forEach(e=>e.classList.remove("active")),a.forEach(e=>e.classList.remove("active")),document.querySelector(`[onclick="openTab('${e}')"]`).classList.add("active"),document.getElementById(e).classList.add("active"),"timeline"==e&&timeLineList){const e=document.getElementById("timelineList");if(0==e.children.length&&timeLineList.length>0){let e="",t=0;timeLineList.forEach(a=>{let s=moment(a.date).format("YYYY-MM-DD"),i=moment(a.date).format("HH:mm");if(""==e)e=s;else{let a=(new Date(s)-new Date(e))/864e5;`${s} 06:00`>`${s} ${i}`&&(s=moment(s).subtract(1,"d").format("YYYY-MM-DD")),e!=s&&(a>1||1==a&&`${s} 06:00`<=`${s} ${i}`)&&($("#timelineList").prepend(`<h5>${e} | ${t}개`),t=0,e=s)}let r="r_legnd";"에픽"==a.itemRarity?r="r_epic":"태초"==a.itemRarity&&(r="r_begin"),a.abyss&&(r+=" abyss"),a.advtMove&&"in"==a.advtMove&&(r+=" advt-in",a.channel+=", 초월보냄");var n=`<div class="${r}">${a.date} | ${a.mistGear||a.begin?"*":""} ${a.itemName} | ${a.channel}</div>`;$("#timelineList").prepend(n),t++}),$("#timelineList").prepend(`<h5>${e} | ${t}개`)}else 0==timeLineList.length&&(e.textContent="데이터가 없습니다.")}else if("pot"==e&&potList){const e=document.getElementById("potList");0==e.children.length&&potList.length>0?(potListAppend(potList),$("#potList > table").addClass("show")):0==timeLineList.length&&(e.textContent="데이터가 없습니다.")}}function filterSpan(e,t,a){e.children().each(function(){const e=$(this),s=$(this).text();"all"!==t&&!e.hasClass("r_"+t)||""!==a&&!s.includes(a)?e.hide():e.show(),setTimeout(()=>{calcPotSFRate()},150)})}function filterSpanTd(e,t,a){e.forEach(e=>{const s=e.classList.contains("r_"+t),i=e.querySelectorAll("td"),r=(i[1]?.textContent||"").includes(a);e.style.display="all"!==t&&!s||""!==a&&!r?"none":""}),setTimeout(()=>{calcPotSFRate()},150)}function potProbability(e,t,a){try{let s=0,i=!1;return e.forEach(e=>{e.pt<a&&(s++,e.t==t.t&&(i=!0))}),{per:(s/11*100).toFixed(2)+"%",vaild:i}}catch(e){return console.error(e),{per:"0.00%",vaild:!1}}}function equipSetAppend(e){try{$("#setInfo").removeClass(["set_begin","set_epic","set_legnd","set_uniq","set_rair"]);let t="";e.setItemRarityName?(t="태초"==e.setItemRarityName?"set_begin":e.setItemRarityName.indexOf("에픽")>-1?"set_epic":e.setItemRarityName.indexOf("레전더리")>-1?"set_legnd":e.setItemRarityName.indexOf("유니크")>-1?"set_uniq":"set_rair",$("#setInfo").addClass(t),$("#setInfo").append(`<span>${e.setItemName}</span><span class="setPt">(${e.setItemRarityName})</span><span class="setPt">${e.setPoint}pt</span>`)):($("#setInfo").append(`<span>${e.setItemName}</span>`),e.setPoint&&$("#setInfo").append(`<span class="setPt">${e.setPoint}pt</span>`))}catch(e){console.error(e)}}function lastUpAppend(e){try{const t=e[0];let a=new Date(t.date+":00"),s=Math.floor((new Date-a)/864e5);$("#h_specTime").text(`장비 마지막 스펙업 이력 (${s}일 전)`),$("#smtb_date").text(t.date),$("#smtb_name").text(t.itemName);let i="r_legnd";if(2==t.r||2.5==t.r?i="r_epic":1!=t.r&&1.5!=t.r||(i="r_begin"),$("#smtb_type").text(convertSlot(changeorderKey("det",t.t))).addClass(i),e.length>1&&e[0].itemName!=e[1].itemName){let t=e[1],a="r_legnd";2==t.r||2.5==t.r?a="r_epic":1!=t.r&&1.5!=t.r||(a="r_begin");let s=`<tr class="bestSetUpdt">\n                  <td>${t.date}</td>\n                  <td>${t.itemName}</td>\n                  <td class="${a}">${convertSlot(changeorderKey("det",t.t))}</td>\n                </tr>`;$("#equipSpecDiv tbody").append(s)}else $("#equipSpecDiv tbody > tr.bestSetUpdt").remove()}catch(e){console.error(e)}}function summaryListAppend(e=[]){let t='<div class="card-header begin">태초 리스트</div><ul class="list-group list-group-flush">',a='<div class="card-header epicList fold">에픽 리스트</div><ul class="list-group list-group-flush epics">',s='<div class="card-header potList fold">항아리 리스트</div><ul class="list-group list-group-flush pots">',i="",r={begin:0,epic:0,pot:0,other:0};try{e.length>0?(e.forEach((e,n)=>{let o="",d="",c="";if(e.abyss&&(o="abyss"),"b"===e.r)r.begin++,e.advtMove&&"in"==e.advtMove?(d="advt-in",c+=' <span class="badge bg-warning rounded-pill">초월보냄</span>'):504==e.code?c+=' <span class="badge bg-warning rounded-pill">항아리&상자</span>':507==e.code?c+=` <span class="badge bg-warning rounded-pill" title="${e.get}">레이드</span>`:511==e.code?c+=' <span class="badge bg-warning rounded-pill">승급</span>':513==e.code?c+=` <span class="badge bg-warning rounded-pill" title="${e.get}">카드</span>`:515==e.code||516==e.code?c+=` <span class="badge bg-warning rounded-pill" title="${e.get}">초월</span>`:c+=`, ${e.get}`,t+=`<li class="list-group-item ${o}" title="${e.date}"><dd>${r.begin}</dd><p class="${d}" tabindex="0" data-title="${e.date}${505!=e.code?", "+e.get:""}"><img class="${d}" src="https://img-api.neople.co.kr/df/items/${e.itemId}">${e.itemName}</p>`,t+=c,t+="</li>";else if(504==e.code)s+=`<li class="list-group-item ${o}" title="${e.date}"><dd>${r.pot+1}</dd><p tabindex="0" data-title="${e.date}"><img src="https://img-api.neople.co.kr/df/items/${e.itemId}">${e.itemName}</p></li>`,e.advtMove&&"in"==e.advtMove&&(s+=' <span class="badge bg-warning rounded-pill">초월보냄</span>'),r.pot++;else if(511==e.code||515==e.code||516==e.code)i+=`<li class="list-group-item ${o}" title="${e.date}"><dd>-</dd><p tabindex="0" data-title="${e.date}"><img src="https://img-api.neople.co.kr/df/items/${e.itemId}">${e.itemName}</p>`,511==e.code?i+=' <span class="badge bg-warning rounded-pill">승급</span>':515!=e.code&&516!=e.code||(i+=' <span class="badge bg-warning rounded-pill">초월</span>'),i+="</li>",r.other++;else{e.advtMove&&"in"==e.advtMove?(d="advt-in",c+=' <span class="badge bg-warning rounded-pill">초월보냄</span>'):507==e.code?c+='<span class="badge bg-warning rounded-pill">레이드</span>':510==e.code?i+=`<li class="list-group-item ${o}" title="${e.date}"><dd>-</dd><p tabindex="0" class="${d}" data-title="${e.date}"><img class="${d}" src="https://img-api.neople.co.kr/df/items/${e.itemId}">${e.itemName}</p> <span class="badge bg-warning rounded-pill">${e.get}</span>`:513==e.code&&(c+=` <span class="badge bg-warning rounded-pill" title="${e.get}">카드</span>`);let t=`<li class="list-group-item ${o}" title="${e.date}"><dd>${n+1-r.begin-r.pot-r.other}</dd><p tabindex="0" class="after-small ${d}" data-title="${e.date}${505!=e.code?", "+e.get:""}"><img class="${d}" src="https://img-api.neople.co.kr/df/items/${e.itemId}">${e.itemName}</p>`;t+=c,t+="</li>",a+=t}}),a+=i,a+="</ul>",t+="</ul>",s+="</ul>"):a+='<li class="list-group-item"> 나만 운없어 </li></ul>',$("#mistList").append(t),$("#mistList").append(a),r.pot>0&&$("#mistList").append(s)}catch(e){console.error(e)}}function potListAppend(e){try{$("#potList *").remove(),$("#potSFRate *").remove(),$("#potSFRate").text("");let t=0,a=0;e.length>0&&(e=e.sort((e,t)=>{if(e.date!=t.date)return new Date(t.date)-new Date(e.date);const a=parseFloat(e.per.replace("%","")),s=parseFloat(t.per.replace("%",""));if(a!=s)return a-s;return("성공"==e.res?0:1)-("성공"==t.res?0:1)}),$("#potList").append('<table class="table summary" style="max-width: 40rem;"><thead>\n                <tr> <th scope="col">날짜</th> \n                  <th scope="col">아이템</th>\n                  <th scope="col" style="display: none;">등급</th>\n                  <th scope="col" style="min-width:4.8em;">부위</th>\n                  <th scope="col" style="min-width:4.8em;">유효 확률</th>\n                  <th scope="col" style="min-width:2.4em;">결과</th>\n                </tr>\n              </thead>\n              <tbody>\n              </tbody>\n            </table>'),e.forEach(e=>{let s="r_legnd";"에픽"==e.itemRarity?s="r_epic":"태초"==e.itemRarity&&(s="r_begin");let i="pot-fail";"성공"==e.res?(i="pot-success",t++):a++,$("#potList tbody").append(`<tr class="${s}"><td>${e.date}</td><td>${e.itemName}</td><td style="display: none;">${e.itemRarity}</td><td class="rare">${convertSlot(changeorderKey("det",e.t))}</td><td>${e.per}</td><td class="pot-res ${i}">${e.res}</td></tr>`)}),$("#potSFRate").append(`<span class="pot-success">${t}</span> / <span class="pot-fail">${a}</span>`))}catch(e){console.error(e)}}function calcPotSFRate(){let e={ps:$("#potSFRate .pot-success").text(),pf:$("#potSFRate .pot-fail").text()},t=0,a=0;try{$("#potList tbody tr:visible").each(function(){const e=$(this).find(".pot-res").text().trim();"성공"==e?t++:"실패"==e&&a++}),$("#potSFRate .pot-success").text(t),$("#potSFRate .pot-fail").text(a)}catch(t){console.error(t),$("#potSFRate .pot-success").text(e.ps),$("#potSFRate .pot-fail").text(e.pf)}}$(document).ready(function(){$("#characterName").keyup(function(){13==window.event.keyCode&&(isRecent=!0,Search())}),$(document).on("click","#btn_lightmode",function(e){ligthModeChange(e.target)}),$(document).on("click","#btn_search",function(){isRecent=!0,Search()}),$(document).on("click",".row.title",function(){try{sessionStorage.clear(),location.href="./"}catch(e){sessionStorage.clear(),location.href="https://dfgear.xyz"}}),$(document).on("click",".fold",function(e){$(e.target).hasClass("open")?($(e.target).removeClass("open"),$(e.target).hasClass("epicList")?$("ul.epics").removeClass("show"):$("ul.pots").removeClass("show")):($(e.target).addClass("open"),$(e.target).hasClass("epicList")?$("ul.epics").addClass("show"):$("ul.pots").addClass("show"))}),$(document).on("click","#btn_epicList",function(){if($(".modal-body").animate({scrollTop:0},200),timeLineList.length>0){$(".modal-list").html("");let e="",t=0;timeLineList.forEach(a=>{let s=moment(a.date).format("YYYY-MM-DD"),i=moment(a.date).format("HH:mm");if(""==e)e=s;else{let a=(new Date(s)-new Date(e))/864e5;`${s} 06:00`>`${s} ${i}`&&(s=moment(s).subtract(1,"d").format("YYYY-MM-DD")),e!=s&&(a>1||1==a&&`${s} 06:00`<=`${s} ${i}`)&&($(".modal-list").prepend(`<h5>${e} | ${t}개`),t=0,e=s)}let r="r_legnd";"에픽"==a.itemRarity?r="r_epic":"태초"==a.itemRarity&&(r="r_begin"),a.abyss&&(r+=" abyss");var n=`<div class="${r}">${a.date} | ${a.mistGear||a.begin?"*":""} ${a.itemName} | ${a.channel}</div>`;$(".modal-list").prepend(n),t++}),$(".modal-list").prepend(`<h5>${e} | ${t}개`)}else $(".modal-list").html("데이터가 없습니다.")}),$(document).on("click","#ft_legnd",function(e){$(this).is(":checked")?($("#setItem .setPoint div.b-레전더리, #setItem .setPoint div.b-유니크, #setItem .setPoint div.b-레어").removeClass("bgImg").children(".itemCount").removeClass("hidden"),$("#setItem .armory div.b-레전더리").removeClass("hidden")):($("#setItem .setPoint div.b-레전더리, #setItem .setPoint div.b-유니크, #setItem .setPoint div.b-레어").addClass("bgImg").children(".itemCount").addClass("hidden"),$("#setItem .armory div.b-레전더리").addClass("hidden"))}),$(document).on("click","#ft_armory",function(e){$(this).is(":checked")?$("#setItem li.armory").removeClass("hidden"):$("#setItem li.armory").addClass("hidden")}),$(document).on("click","#aName",function(e){return sessionStorage.setItem("sId","adventure"),sessionStorage.setItem("cName",$(e.target).text()),location.href=`https://dfgear.xyz/adventure?cName=${encodeURIComponent($(e.target).text())}`}),$(window).resize(function(){$("#loadingScreen").css("height",$(document).height())}),$(document).on("click","#btn_chracterHide,#btn_chracterShow",function(){hideCharacter($("#openHide").attr("data-hide"))}),$("#hideModal").on("shown.bs.modal",function(){if(isHideOption){checkRequest($("#openHide").attr("data-hide"))}}),$("#timeLineRarity").on("change",function(){const e=$(this).val();filterSpan($("#timelineList"),e,$("#timeLineItemFilter").val())}),$("#potRarity").on("change",function(){const e=$(this).val();filterSpanTd(document.querySelectorAll("#potList tbody tr"),e,$("#potItemFilter").val())}),$("#timeLineItemFilter").on("input",function(){clearTimeout(debounceTimer);const e=$("#timeLineRarity").val(),t=$("#timelineList"),a=$(this).val();debounceTimer=setTimeout(function(){filterSpan(t,e,a)},400)}),$("#potItemFilter").on("input",function(){clearTimeout(debounceTimer);const e=$("#potRarity").val(),t=document.querySelectorAll("#potList tbody tr"),a=$(this).val();debounceTimer=setTimeout(function(){filterSpanTd(t,e,a)},400)});try{serverId=sessionStorage.getItem("sId")?sessionStorage.getItem("sId"):new URLSearchParams(location.search).get("sId"),characterId=sessionStorage.getItem("cId")?sessionStorage.getItem("cId"):new URLSearchParams(location.search).get("cId"),characterName=sessionStorage.getItem("cName")?sessionStorage.getItem("cName"):new URLSearchParams(location.search).get("cName"),""==characterId||null===characterId||""==serverId||null===serverId?($("#searchBar").addClass("show"),$("select[name='server']").val("all"),$("input[name='name']").val(""),sessionStorage.clear()):($("select[name='server']").val(serverId),$("input[name='name']").val(characterName),characterName=decodeURIComponent(characterName),sessionStorage.clear(),Search(characterId))}catch(e){return toast("danger","캐릭터명을 다시 입력해주세요"),sessionStorage.clear(),$("#searchBar").addClass("show")}});