let apioff=!1,nowDate=moment().format("YYYYMMDDTHHmm");const characterMap={};let unluckyList,pageRange=10,currentPage=1;function loadingToggle(e=!0){e?($("#loadingScreen").css("height",$(document).height()),$("#loadingScreen").addClass("active"),$("#btn_search").addClass("disabled")):($("#loadingScreen").removeClass("active"),$("#btn_search").removeClass("disabled"))}function getList(){try{if(apioff||"0"===sessionStorage.getItem("serverState"))return toast("warning","DFGEAR 서버 점검");let e=localStorage.getItem("unlucky");if(null!=e){let t=JSON.parse(e);t.update<=moment().subtract(5,"m").format("YYYYMMDDTHHmm")?searchList({page:1},function(e,t){try{if(t){if(loadingToggle(!1),!e.responseText)return console.log(t),console.log(e),alert("에러 발생");checkError(e.responseText)}else{if(!(e.data&&e.data.length>0))return loadingToggle(!1),$("#table").text("랭킹 리스트를 불러오는데 실패했습니다."),toast("danger","랭킹 리스트를 불러오는데 실패했습니다.");createTable(e.data),localStorage.setItem("unlucky",JSON.stringify(e))}}catch(e){return loadingToggle(!1),alert("에러 발생")}}):createTable(t.data)}else searchList({page:1},function(e,t){try{if(t){if(loadingToggle(!1),!e.responseText)return console.log(t),console.log(e),alert("에러 발생");checkError(e.responseText)}else{if(!(e.data&&e.data.length>0))return loadingToggle(!1),$("#table").text("랭킹 리스트를 불러오는데 실패했습니다."),toast("danger","랭킹 리스트를 불러오는데 실패했습니다.");createTable(e.data),localStorage.setItem("unlucky",JSON.stringify(e))}}catch(e){return loadingToggle(!1),alert("에러 발생")}})}catch(e){return loadingToggle(!1),alert("에러 발생")}}function searchList(e,t){try{loadingToggle(!0),callGearAPI("/unluckyRanking",e,function(e,a){loadingToggle(!1),t(e,a)})}catch(e){console.log(e)}}function createTable(e){try{unluckyList=new tui.Grid({el:document.getElementById("table"),data:e,bodyHeight:"fitToParent",columns:[{header:"순위",name:"rank",sortable:!0,width:64,align:"center"},{header:"캐릭터명",name:"characterName",align:"center",minWidth:155,renderer:{type:characterIcon}},{header:"명성",name:"fame",width:50,align:"center"},{header:"직업",name:"jobGrowName",align:"center"},{header:"심연:숭배자",name:"abyss",sortable:!0,align:"center"},{header:"에픽",name:"epic",sortable:!0,align:"center"},{header:"레전더리",name:"legnd",width:80,sortable:!0,align:"center"},{header:"노력점수",name:"effort",minWidth:78,sortable:!0,align:"center"}],header:{height:45},rowHeight:50,columnOptions:{resizable:!0},scrollY:!0,useClientSort:!0,onGridMounted(e){unluckyList.getData().forEach((e,t)=>{characterMap[e.characterName]=`https://img-api.neople.co.kr/df/servers/${e.sId}/characters/${e.cId}/`}),unluckyList.on("click",e=>{"etc"!==e.targetType&&"columnHeader"!==e.targetType&&"characterName"===e.columnName&&(location.href=`./character?sId=${unluckyList.getValue(e.rowKey,"sId")}&cId=${unluckyList.getValue(e.rowKey,"cId")}&cName=1`)}),$(".list-number").removeClass("hidden"),$(document).on("click",".list-number > li",function(e){if(""===this.className){let e=this.children[0].innerText;if(e==currentPage)return;Search(unluckyList,e),$(".current").removeClass("current"),this.className="current"}else changePage(this.className)})}})}catch(e){console.error(e)}}function Search(e,t){try{if(t==currentPage)return;if("1"==t){let a=localStorage.getItem("unlucky");if(null!=a){let n=JSON.parse(a);if(n.update<=moment().subtract(5,"m").format("YYYYMMDDTHHmm"))return e.resetData(n.data),void(currentPage=t)}}searchList({page:t},function(a,n){try{if(currentPage=t,n){if(loadingToggle(!1),!a.responseText)return console.log(n),console.log(a),alert("에러 발생");checkError(a.responseText)}else{if(!(a.data&&a.data.length>0))return loadingToggle(!1),$("#table").text("랭킹 리스트를 불러오는데 실패했습니다."),toast("danger","랭킹 리스트를 불러오는데 실패했습니다.");e.resetData(a.data)}}catch(e){return loadingToggle(!1),alert("에러 발생")}})}catch(e){console.log(e)}}function changePage(e){"back"==e?(pageRange-=10,pageRange<10&&(pageRange=10)):"next"==e&&(pageRange+=10,pageRange>50&&(pageRange=50));for(var t=0;t<10;t++){let e=pageRange-t;$(".list-number > li").eq(10-t).children()[0].innerText=e}}tui.Grid.applyTheme("default",{cell:{normal:{background:"#fff"},header:{background:"#fff",border:"#e0e0e0"},selectedHeader:{background:"#fff"},disabled:{background:"#dc3545",text:"#fff"},focused:{border:"none"}}}),$(document).ready(function(){nowDate=moment().format("YYYYMMDDTHHmm"),$(document).on("click","#btn_lightmode",function(e){ligthModeChange(e.target)}),$(document).on("click",".row.title",function(){try{location.href="./"}catch(e){sessionStorage.clear(),location.href="https://dfgear.xyz"}}),$(window).resize(function(){$("#loadingScreen").css("height",$(document).height())}),getList()});