let aggreInterval,mistMapChart,apioff=!1,timeLineList=[],nowDate=moment().format("YYYYMMDDTHHmm"),serverId="",characterName="",characterId="",limit200=!1,isRecent=!1;function Search(){if(apioff||"0"===sessionStorage.getItem("serverState"))return toast("warning","DFGEAR 서버 점검");var e=$("select[name='server']").val(),t=$("input[name='name']").val();if((t=t.trim()).length<1)return toast("danger","캐릭터명을 입력해주세요."),$("#characterName").focus();if(nowDate=moment().subtract(1,"m").format("YYYYMMDDTHHmm"),$(".resultData").removeClass("show"),$("#characterList").html(""),$("#advenResult").removeClass("show"),$("#btn_mistList").removeClass("show"),"adventure"===e){if(t.length>29)return toast("danger","모험단명은 30자리 이내로 입력해주세요"),$("#searchBar").addClass("show"),$("#characterName").focus();loadingToggle(),searchAdventure(t,function(a,r){sessionStorage.clear(),limit200=!1,$("#searchError").removeClass("show");try{if(r){if(loadingToggle(!1),!a.responseText)return console.log(r),console.log(a),alert("에러 발생");$("#searchError").text(`"${t}" 검색 결과`).addClass("show"),checkError(a.responseText)}else{if(!(a.rows&&a.rows.length>0))return loadingToggle(!1),$("#advenResult").removeClass("show"),$("#btn_mistList").removeClass("show"),$("#searchError").text(`"${t}" 검색 결과`).addClass("show"),toast("danger","모험단에 소속된 캐릭터 정보가 없습니다.");sessionStorage.setItem("advtNM",t),makeCardView(a.rows,!0),$(".recentBox").removeClass("active"),""!=a.summary&&void 0!==a.summary.begin&&(limit200=!0,$("#advenTotal").contents()[0].textContent=`태초 : ${a.summary.begin}, 에픽 : ${a.summary.epic} (+항아리: ${a.summary.potEpic})`),isRecent&&(recentApply(e,t,""),isRecent=!1)}}catch(e){return sessionStorage.clear(),loadingToggle(!1),"NO_CHARACTER"===e?toast("danger","모험단에 소속된 캐릭터 정보가 없습니다."):alert("에러 발생")}})}else{if(t.length>20)return toast("danger","캐릭터명은 20자리 이내로 입력해주세요"),$("#searchBar").addClass("show"),$("#characterName").focus();loadingToggle(),searchAll(e,t,function(a,r){sessionStorage.clear();try{if(r){if(loadingToggle(!1),!a.responseText)return console.log(r),console.log(a),alert("에러 발생");checkError(a.responseText)}else{if(!a.rows||!(a.rows.length>1||"all"==e))return a.rows&&1==a.rows.length&&"all"!=e?(loadingToggle(!1),sessionStorage.clear(),sessionStorage.setItem("sId",e),sessionStorage.setItem("cName",t),sessionStorage.setItem("cId",a.rows[0].characterId),location.href="https://dfgear.xyz/character"):(loadingToggle(!1),$("#advenResult").removeClass("show"),$("#btn_mistList").removeClass("show"),$("#searchError").text(`"${t}" 검색 결과`).addClass("show"),$("#searchErrorDetail").addClass("show"),$(".recentBox").removeClass("active"),toast("danger","일치하는 캐릭터 정보가 없습니다"));makeCardView(a.rows,!1),$("#advenTotal").html(`${t} 조회 결과`),$(".recentBox").removeClass("active")}}catch(e){return sessionStorage.clear(),loadingToggle(!1),"NO_CHARACTER"===e?toast("danger","일치하는 캐릭터 정보가 없습니다"):alert("에러 발생")}})}}function loadingToggle(e=!0){e?($("#loadingScreen").css("height",$(document).height()),$("#loadingScreen").addClass("active"),$("#btn_search").addClass("disabled")):($("#loadingScreen").removeClass("active"),$("#btn_search").removeClass("disabled"))}function makeCardView(e,t=!0){try{let a=0,r=0,n=0,s=0;$("#characterList").html(""),e.forEach(e=>{try{let t=`<div class="card characterView" data-cId="${e.characterId}" data-sId="${e.serverId}" onclick="location.href='/character?sId=${e.serverId}&cId=${e.characterId}&cName=${encodeURIComponent(e.characterName)}';">\n        <div class="raidCnt flex flex-row items-center gap-1"><img src="./static/images/raid.png"><div>${e.raidCnt||"0"}</div></div>\n        <img src="https://img-api.neople.co.kr/df/servers/${e.serverId}/characters/${e.characterId}?zoom=4" class="card-img-top" alt="...">\n          <div class="card-body"><div class="flex flex-row gap-1 items-center ho-c"><img class="g-chimg" src="./static/images/fame.png"><div class="fameNumber">${e.fame}</div></div>  `;t+=`<span class="card-text cName uselct">${e.characterName}</span>            \n          <p class="card-text jobserver">${convertServer(e.serverId)}<span></span>${e.jobGrowName}</p>`,t+=`<span class="card-text uselct be">태초 획득 : ${e.begin}</span>\n            <span class="card-text uselct to">에픽 획득 : ${e.epic}</span>\n            <span class="card-text uselct mi">레전더리 획득 : ${e.legnd}</span>\n            <span class="card-text uselct mb-1">심연:숭배자 : ${e.abyss?e.abyss:"-"}</span>\n            <span class="card-text uselct mb-2 potCount ${e.potEpic+e.potLegnd>0?"show":""}">항아리 : <span class="r_epic">${e.potEpic}</span> / <span class="r_legnd">${e.potLegnd}</span></span>\n            <span class="card-text small">최근 업데이트</span>\n            <span class="card-text small da">${null==e.uptime?"-":e.uptime}</span>\n          </div>\n        </div>`,a+=parseInt(e.epic),r+=parseInt(e.begin),n+=parseInt(e.potEpic),e.raidCnt&&(s+=parseInt(e.raidCnt)),$("#characterList").append(t)}catch(e){console.log(e)}}),t?($("#advenTotal").contents()[0].textContent=`태초 : ${r}, 에픽 : ${a} (+항아리: ${n})`,$("#raidCntTotal > div").text(s),$("#advenRefresh").show(),$("#raidCntTotal").show()):($("#advenTotal").contents()[0].textContent=`${e[0].characterName} 조회 결과`,$("#advenRefresh").hide(),$("#raidCntTotal").hide()),$("#advenResult").addClass("show"),loadingToggle(!1)}catch(e){loadingToggle(!1),console.log(e)}}function searchAdventure(e,t){try{let a={adventureName:encodeURIComponent(e)};$.ajax({url:api+"/adventure",type:"get",timeout:6e4,processData:!0,beforeSend:function(e){e.setRequestHeader("Content-type","application/json;charset=UTF-8"),e.setRequestHeader("gear","dfgear")},data:a,success:function(e,a,r){t(e,null)},error:function(e,a){t(e,a)}})}catch(e){sessionStorage.clear(),console.log(e)}}function searchAll(e,t,a){try{let r={cName:encodeURIComponent(t)};$.ajax({url:api+"/search/"+e,type:"get",timeout:6e4,processData:!0,beforeSend:function(e){e.setRequestHeader("Content-type","application/json;charset=UTF-8"),e.setRequestHeader("gear","dfgear")},data:r,success:function(e,t,r){a(e,null)},error:function(e,t){a(e,t)}})}catch(e){sessionStorage.clear(),console.log(e)}}function searchCharacterRefresh(e,t,a,r="",n=!1){return new Promise((s,o)=>{try{let c={sId:e,cName:encodeURIComponent(r),cId:t,last:n?1:0,aName:encodeURIComponent(a)};$.ajax({url:api+"/character/v2/TimelineRefresh",type:"get",timeout:6e4,processData:!0,beforeSend:function(e){e.setRequestHeader("Content-type","application/json;charset=UTF-8"),e.setRequestHeader("gear","dfgear")},data:c,success:function(e){s(e,null)},error:function(e,t){o(e,t)}})}catch(e){sessionStorage.clear(),console.log(e)}})}$(document).ready(function(){nowDate=moment().format("YYYYMMDDTHHmm");try{serverId="adventure";var e=new URLSearchParams(location.search).get("cName");characterName=e||sessionStorage.getItem("cName"),null!=characterName&&""!==characterName&&($("select[name='server']").val(serverId),$("input[name='name']").val(characterName),"adventure"==serverId&&Search())}catch(e){console.log(e),$("select[name='server']").val("adventure"),$("input[name='name']").val(""),sessionStorage.clear()}try{let e=localStorage.getItem("recent");e=null!=e?JSON.parse(e):[],e.length>0&&($(".recentBox").addClass("active"),recentView(e))}catch(e){$(".recentBox").removeClass("active")}$("#characterName").keyup(function(){13==window.event.keyCode&&(isRecent=!0,Search())}),$("#characterName").focus(function(e){if($(".recentBox").hasClass("active"))return;let t=localStorage.getItem("recent");t=null!=t?JSON.parse(t):[],t.length>0&&($(".recentBox").addClass("active"),recentView(t))}),$(document).on("click","#btn_search",function(){isRecent=!0,Search()}),$(document).on("click","#btn_lightmode",function(e){ligthModeChange(e.target)}),$(document).on("click","#advenTotal > text",function(){if("adventure"!=$("select[name='server']").val())return;var e=$("input[name='name']").val();let t=`https://dfgear.xyz/adventure?cName=${encodeURIComponent(e)}`;navigator.clipboard.writeText(t).then(()=>{toast("info","링크 복사됨")}).catch(e=>{console.log("Something went wrong",e)})}),$(document).on("click",".row.title",function(){try{location.href="./"}catch(e){sessionStorage.clear(),location.href="https://dfgear.xyz"}}),$(document).on("click","#advenTotal > span",function(){try{let e=$("#characterName").val();location.href="./advtDetail?name="+e}catch(e){sessionStorage.clear(),location.href="https://dfgear.xyz"}}),$(document).on("click","#btn_mistList",function(){$(".modal-body").animate({scrollTop:0},200)}),$(document).on("click",".r-list > div > label",function(e){console.log(e);let t=$(e.target).attr("data-num");recentDelete(parseInt(t))}),$(document).on("click","#advenRefresh",function(){try{var e=$("input[name='name']").val();if(e.length<1)return toast("danger","모험단명을 입력해주세요."),$("#characterName").focus();if(limit200){if(!confirm(`${e} 모험단에 등록된 캐릭터 수가 200개가 넘어 명성이 높고 태초를 획득했던 캐릭터 200개만 갱신이 가능합니다. 갱신하시겠습니까?`))return}else if(!confirm(`${e} 모험단의 타임라인을 갱신하시겠습니까?`))return;loadingToggle();let t=$(".characterView");!async function(){try{let e=0,a=0,r=0,n=0,s=0,o="";for(let c of t){let l=$(c).attr("data-sid"),i=$(c).attr("data-cid"),d=$(c).children("div").children(".cName").text(),m=$("input[name='name']").val();await searchCharacterRefresh(l,i,m,d,e==t.length-1).then(e=>{if(e.code&&"Already Refresh"==e.code)throw toast("info","해당 모험단은 2시간 이내에 갱신되었습니다."),"forescape";if(e.row){let t=e.row;$(c).children("div").children("div").children(".fameNumber").text(t[0].fame),$(c).children("div").children(".be").text(`태초 획득 : ${t[0].begin}`),$(c).children("div").children(".to").text(`에픽 획득 : ${t[0].epic}`),$(c).children("div").children(".mi").text(`레전더리 획득 : ${t[0].legnd}`),$(c).children("div").children(".potCount").html(`항아리 : <span class="r_epic">${t[0].potEpic}</span> / <span class="r_legnd">${t[0].potLegnd}</span>`),t[0].potEpic+t[0].potLegnd>0?$(c).children("div").children(".potCount").addClass("show"):$(c).children("div").children(".potCount").removeClass("show"),$(c).children("div").children(".da").text(t[0].uptime),a+=parseInt(t[0].epic),r+=parseInt(t[0].begin),n+=parseInt(t[0].potEpic),t[0].raidCnt&&($(c).children(".raidCnt").children("div").text(t[0].raidCnt),s+=parseInt(t[0].raidCnt))}""!=e.summary&&(o=e.summary)}).catch(e=>{if(console.log(e),e.responseJSON.code&&"Already Refresh"==e.responseJSON.code)throw toast("info","해당 모험단은 2시간 이내에 갱신되었습니다."),"forescape";if(!e.responseJSON.error||"NOT_FOUND_CHARACTER"!=e.responseJSON.error.message)throw toast("info","해당 모험단 갱신에 오류가 발생했습니다. 관리자에게 문의주세요"),"forescape";console.log("캐릭터 정보가 이제 없음")}),e++}""===o?($("#advenTotal").contents()[0].textContent=`태초 : ${r}, 에픽 : ${a} (+항아리: ${n})`,$("#raidCntTotal > div").text(s)):($("#advenTotal").contents()[0].textContent=`태초 : ${o.begin}, 에픽 : ${o.epic} (+항아리: ${o.potEpic})`,$("#raidCntTotal > div").text(o.raidCnt||"0"))}catch(e){loadingToggle(!1)}loadingToggle(!1)}()}catch(e){sessionStorage.clear(),console.log(e),loadingToggle(!1)}}),$(window).resize(function(){$("#loadingScreen").css("height",$(document).height())})});