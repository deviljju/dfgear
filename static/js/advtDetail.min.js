let nowDate=moment().format("YYYYMMDDTHHmm"),adventureName="",apioff=!1;function Search(){if(apioff||"0"===sessionStorage.getItem("serverState"))return toast("warning","DFGEAR 서버 점검");nowDate=moment().subtract(1,"m").format("YYYYMMDDTHHmm"),loadingToggle(),$("#mistList").html(""),adventureDetail(function(e,a){try{if(sessionStorage.clear(),timeLineList=[],a){if(loadingToggle(!1),!e.responseText)return console.log(a),console.log(e),alert("에러 발생");checkError(e.responseText)}else{if(e.error)return loadingToggle(!1),$(".resultData").removeClass("show"),"APIKEY_AUTH_ERROR"==e.error.message?toast("danger","에러 발생_APIKEY오류"):"SYSTEM_INSPECT"==e.error.message?(apioff=!0,toast("danger","DNF점검")):(console.log(e),toast("danger","에러 발생_캐릭터정보오류"));if(!(e.rows.length>0))return loadingToggle(!1),$(".resultData").removeClass("show"),alert("모험단 상세정보를 불러오는데 실패했습니다.");data_List(e)}}catch(e){return sessionStorage.clear(),console.error(e),loadingToggle(!1),$(".resultData").removeClass("show"),$("#mistList").html(""),"NO_CHARACTER"===e?toast("danger","일치하는 캐릭터 정보가 없습니다"):"NOT_FOUND_CHARACTER"===e?toast("danger","캐릭터 정보를 찾을 수 없습니다"):alert("에러 발생")}})}function loadingToggle(e=!0){e?($("#loadingScreen").css("height",$(document).height()),$("#loadingScreen").addClass("active"),$("#btn_search").addClass("disabled")):($("#loadingScreen").removeClass("active"),$("#btn_search").removeClass("disabled"))}function makeCardView(e){try{$(".characterView").html(""),characterId=e.characterId,$(".characterView").attr("data-cId",e.characterId),$(".characterView").attr("data-sId",e.serverId);let a=`<span class="famehigh">명성이 가장 높은 캐릭터</span><img src="https://img-api.neople.co.kr/df/servers/${e.serverId}/characters/${e.characterId}/" class="card-img-top" alt="...">\n      <div class="card-body"><div class="flex flex-row gap-1 items-center ho-c"><img class="g-chimg" src="./static/images/fame.png"><div class="fameNumber">${e.fame}</div></div>  \n       <span id="cName" class="card-text uselct">${e.characterName}</span>          \n          <div style="text-align: -webkit-center"><p id="aName" class="card-text uselct" style="width:max-content;margin-bottom: 1rem !important;">${e.adventureName}</p></div>`;a+=`<span class="card-text uselct">태초 획득 : ${e.begin}</span>\n          <span class="card-text uselct">에픽 획득 : ${e.epic}</span>          \n          <span class="card-text uselct">레전더리 획득 : ${e.legnd}</span>\n          <span class="card-text uselct mb-1">심연:숭배자 : ${e.abyss?e.abyss:"-"}</span>\n          <span class="card-text uselct mb-2 potCount ${e.potBegin+e.potEpic+e.potLegnd>0?"show":""}">항아리 : <span class="r_begin">${e.potBegin}</span> / <span class="r_epic">${e.potEpic}</span> / <span class="r_legnd">${e.potLegnd}</span></span>\n          <span class="card-text small">최근 업데이트</span>\n          <span class="card-text small mb-1">${moment(e.updatedAt).format("YYYY-MM-DD HH:mm:ss")}</span>\n          <a href="https://dundam.xyz/character?server=${e.serverId}&key=${e.characterId}" target="_blank"><img src="https://dundam.xyz/007.png" alt="던담 바로가기" style="height:2.375rem; border-radius: 0.5em;"/></a>\n        </div>`,$(".characterView").append(a)}catch(e){console.log(e)}}function data_List(e){$("#advName").text(e.adventureName);let a='<div class="card-header legacy">태거시 리스트</div><ul class="list-group list-group-flush">',t='<div class="card-header begin">태초 리스트</div><ul class="list-group list-group-flush">',s='<div class="card-header potList">항아리 리스트</div><ul class="list-group list-group-flush pots">',n="",r="",c={legacy:0,begin:0,epic:0,legnd:0,pot:0,cardLB:0,cardB:0,potLB:0,potB:0,transB:0,transLB:0,potEpic:0,potLegnd:0,abyss:0};try{e.timeline.forEach((a,s)=>{let r="",l="";if(a.sp&&(r="abyss"),a.advtIn&&(l="advt-in"),"태초"==a.itemRarity)if(null==a.itemType||0==e.legacy.length)515==a.code||516==a.code?(c.transB++,n+=`<li class="list-group-item ${r}" title="${moment(a.date).format("YYYY-MM-DD HH:mm")}">\n            <dd>-</dd>\n            <div class="smallIcon ${a.jobCss}" style="background-image: url('https://img-api.neople.co.kr/df/servers/${a.serverId}/characters/${a.characterId}?zoom=1');"></div>\n            <p class="${l}" tabindex="0" data-title="${moment(a.date).format("YYYY-MM-DD HH:mm")}"><img src="https://img-api.neople.co.kr/df/items/${a.itemId}">${a.itemName}</p>\n            <span class="badge bg-warning rounded-pill" title="${a.channel}">초월</span></li>`):(c.begin++,t+=`<li class="list-group-item ${r}" title="${moment(a.date).format("YYYY-MM-DD HH:mm")}">\n            <dd>${c.begin}</dd>\n            <div class="smallIcon ${a.jobCss}" style="background-image: url('https://img-api.neople.co.kr/df/servers/${a.serverId}/characters/${a.characterId}?zoom=1');"></div>\n            <p class="${l}" tabindex="0" data-title="${moment(a.date).format("YYYY-MM-DD HH:mm")}${505!=a.code?", "+a.channel:""}"><img src="https://img-api.neople.co.kr/df/items/${a.itemId}">${a.itemName}</p>`,504==a.code?(c.potB++,t+=' <span class="badge bg-warning rounded-pill">항아리&상자</span>'):507==a.code?(c.cardB++,t+=` <span class="badge bg-warning rounded-pill" title="${a.channel}">레이드</span>`):513==a.code&&(c.cardB++,t+=` <span class="badge bg-warning rounded-pill" title="${a.channel}">카드</span>`),t+="</li>");else{let s;for(leg of e.legacy)if(a.characterId==leg.characterId&&a.itemName==leg.itemName){s=leg;break}null==s&&(515==a.code||516==a.code?(c.transB++,n+=`<li class="list-group-item ${r}" title="${moment(a.date).format("YYYY-MM-DD HH:mm")}">\n              <dd>-</dd>\n              <div class="smallIcon ${a.jobCss}" style="background-image: url('https://img-api.neople.co.kr/df/servers/${a.serverId}/characters/${a.characterId}?zoom=1');"></div>\n              <p class="${l}" tabindex="0" data-title="${moment(a.date).format("YYYY-MM-DD HH:mm")}${505!=a.code?", "+a.channel:""}"><img src="https://img-api.neople.co.kr/df/items/${a.itemId}">${a.itemName}</p>\n              <span class="badge bg-warning rounded-pill" title="${a.channel}">초월</span></li>`):(c.begin++,t+=`<li class="list-group-item ${r}" title="${moment(a.date).format("YYYY-MM-DD HH:mm")}">\n              <dd>${c.begin}</dd>\n              <div class="smallIcon ${a.jobCss}" style="background-image: url('https://img-api.neople.co.kr/df/servers/${a.serverId}/characters/${a.characterId}?zoom=1');"></div>\n              <p class="${l}" tabindex="0" data-title="${moment(a.date).format("YYYY-MM-DD HH:mm")}${505!=a.code?", "+a.channel:""}"><img src="https://img-api.neople.co.kr/df/items/${a.itemId}">${a.itemName}</p>`,504==a.code?(c.potB++,t+=' <span class="badge bg-warning rounded-pill">항아리&상자</span>'):507==a.code?(c.cardB++,t+=` <span class="badge bg-warning rounded-pill" title="${a.channel}">레이드</span>`):513==a.code&&(c.cardB++,t+=` <span class="badge bg-warning rounded-pill" title="${a.channel}">카드</span>`),t+="</li>"))}}),e.legacy.forEach((e,t)=>{if(null!=e.itemType){let t="",s="";e.sp&&(t="abyss"),e.advtIn&&(s="advt-in"),515==e.code||516==e.code?(c.transLB++,r+=`<li class="list-group-item ${t}" title="${moment(e.date).format("YYYY-MM-DD HH:mm")}">\n          <dd>-</dd>\n          <div class="smallIcon ${e.jobCss}" style="background-image: url('https://img-api.neople.co.kr/df/servers/${e.serverId}/characters/${e.characterId}?zoom=1');"></div>\n          <p class="${s}" tabindex="0" data-title="${moment(e.date).format("YYYY-MM-DD HH:mm")}"><img src="https://img-api.neople.co.kr/df/items/${e.itemId}">${e.itemName}</p>\n          <span class="badge bg-warning rounded-pill" title="${e.channel}">초월</span></li>`):(c.legacy++,a+=`<li class="list-group-item ${t}" title="${moment(e.date).format("YYYY-MM-DD HH:mm")}">\n          <dd>${c.legacy}</dd>\n          <div class="smallIcon ${e.jobCss}" style="background-image: url('https://img-api.neople.co.kr/df/servers/${e.serverId}/characters/${e.characterId}?zoom=1');"></div>\n          <p class="${s}" tabindex="0" data-title="${moment(e.date).format("YYYY-MM-DD HH:mm")}${505!=e.code?", "+e.channel:""}"><img src="https://img-api.neople.co.kr/df/items/${e.itemId}">${e.itemName}</p>`,504==e.code?(c.potLB++,a+=' <span class="badge bg-warning rounded-pill">항아리&상자</span>'):507==e.code?(c.cardLB++,a+=` <span class="badge bg-warning rounded-pill" title="${e.channel}">레이드</span>`):513==e.code&&(c.cardLB++,a+=` <span class="badge bg-warning rounded-pill" title="${e.channel}">카드</span>`),a+="</li>")}}),s+="</ul>",timeLineList=e.timeline,c.begin+c.transB>0?(n.length>0&&(t+=n),t+="</ul>"):t+='<li class="list-group-item"> 나만 운없어 </li></ul>',c.legacy+c.transLB>0&&(r.length>0&&(a+=r),a+="</ul>",$("#mistList").append(a)),$("#mistList").append(t),c.pot>0&&$("#mistList").append(s),$(".resultData").addClass("show");let i={begin:0};if(""!=e.summary&&void 0!==e.summary.legnd?(c.epic=e.summary.epic,c.legnd=e.summary.legnd,c.potEpic=e.summary.potEpic,c.potLegnd=e.summary.potLegnd,c.abyss=e.summary.abyss,i=e.summary.many):e.rows.forEach(e=>{c.epic+=e.epic,c.legnd+=e.legnd,c.potEpic+=e.potEpic,c.potLegnd+=e.potLegnd,c.abyss+=e.abyss,e.begin>i.begin&&(i=e)}),$("#totalB").text(c.begin+c.legacy),$("#dropB").text(`드랍:${c.begin+c.legacy-c.cardB-c.cardLB-c.potB-c.potLB}개`),$("#cardB").text(`카드:${c.cardB+c.cardLB}개`),$("#potB").text(`항아리:${c.potB+c.potLB}개`),$("#transB").text(`초월:${c.transB+c.transLB}개`),$("#totalE").text(c.epic),$("#totalL").text(c.legnd),$("#totalPe").text(c.potEpic),$("#totalPl").text(c.potLegnd),$("#totalAbyss").text(c.abyss),$("#lucky > div").css("background-image",`url('https://img-api.neople.co.kr/df/servers/${i.serverId}/characters/${i.characterId}?zoom=1')`),$("#lucky > div").addClass(i.jobCss),$("#lk_name").text(i.characterName),$("#lk_name").on("click",e=>{let a=`https://dfgear.xyz/character?sId=${i.serverId}&cId=${i.characterId}&cName=${i.characterName}`;window.open(a,"_self")}),c.begin+c.legacy>0&&(0==c.epic?$("#b_rate").text("(1.00)"):$("#b_rate").text(`(${((c.begin+c.legacy)/c.epic).toFixed(3)})`)),$("#channels > div").remove(),e.channel&&e.channel.length>0)for(var l of($("#channels").removeClass("hidden"),e.channel=e.channel.slice(0,5),e.channel))$("#channels").append(`<div><h4 id="ch1">${l.cn}</h4><h5 id="ch1cnt">${l.cnt}개</h5></div>`);else $("#channels").addClass("hidden")}catch(e){console.error(e)}makeCardView(e.rows[0]),loadingToggle(!1)}function adventureDetail(e){try{let a={id:adventureName};$.ajax({url:api+"/adventure/detail/"+adventureName,type:"get",timeout:3e4,processData:!0,beforeSend:function(e){e.setRequestHeader("Content-type","application/json;charset=UTF-8"),e.setRequestHeader("gear","dfgear")},data:a,success:function(a,t,s){e(a,null)},error:function(a,t){e(a,t)}})}catch(e){sessionStorage.clear(),console.log(e)}}$(document).ready(function(){$(document).on("click","#btn_lightmode",function(e){ligthModeChange(e.target)}),$(document).on("click",".row.title",function(){try{location.href="./"}catch(e){sessionStorage.clear(),location.href="https://dfgear.xyz"}}),$(document).on("click",".potList",function(){$(".card-header.potList").hasClass("open")?($(".card-header.potList").removeClass("open"),$("ul.pots").removeClass("show")):($(".card-header.potList").addClass("open"),$("ul.pots").addClass("show"))}),$(document).on("click","#aName",function(e){return sessionStorage.setItem("sId","adventure"),sessionStorage.setItem("cName",$(e.target).text()),location.href=`https://dfgear.xyz/adventure?cName=${encodeURIComponent($(e.target).text())}`}),$(window).resize(function(){$("#loadingScreen").css("height",$(document).height())});try{adventureName=sessionStorage.getItem("advtNM")?sessionStorage.getItem("advtNM"):new URLSearchParams(location.search).get("name"),""==adventureName||null===adventureName?(alert("모험단 정보를 다시 선택해주세요"),sessionStorage.clear(),location.href="https://dfgear.xyz/adventure"):Search()}catch(e){alert("모험단 정보를 다시 선택해주세요"),sessionStorage.clear(),location.href="https://dfgear.xyz/adventure"}});